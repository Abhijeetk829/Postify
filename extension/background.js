/*! For license information please see background.js.LICENSE.txt */
(()=>{var e={418:(e,t,a)=>{"use strict";e=a.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,n=(e=0)=>(t,a,r)=>`[${38+e};2;${t};${a};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[a,r]of Object.entries(t)){for(const[a,n]of Object.entries(r))t[a]={open:`[${n[0]}m`,close:`[${n[1]}m`},r[a]=t[a],e.set(n[0],n[1]);Object.defineProperty(t,a,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=n(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=n(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,a)=>e===t&&t===a?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:a}=t.groups;3===a.length&&(a=a.split("").map((e=>e+e)).join(""));const r=Number.parseInt(a,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},526:(e,t)=>{"use strict";t.byteLength=function(e){var t=o(e),a=t[0],r=t[1];return 3*(a+r)/4-r},t.toByteArray=function(e){var t,a,i=o(e),s=i[0],c=i[1],l=new n(function(e,t,a){return 3*(t+a)/4-a}(0,s,c)),u=0,d=c>0?s-4:s;for(a=0;a<d;a+=4)t=r[e.charCodeAt(a)]<<18|r[e.charCodeAt(a+1)]<<12|r[e.charCodeAt(a+2)]<<6|r[e.charCodeAt(a+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===c&&(t=r[e.charCodeAt(a)]<<2|r[e.charCodeAt(a+1)]>>4,l[u++]=255&t),1===c&&(t=r[e.charCodeAt(a)]<<10|r[e.charCodeAt(a+1)]<<4|r[e.charCodeAt(a+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},t.fromByteArray=function(e){for(var t,r=e.length,n=r%3,i=[],s=16383,o=0,l=r-n;o<l;o+=s)i.push(c(e,o,o+s>l?l:o+s));return 1===n?(t=e[r-1],i.push(a[t>>2]+a[t<<4&63]+"==")):2===n&&(t=(e[r-2]<<8)+e[r-1],i.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"=")),i.join("")};for(var a=[],r=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)a[s]=i[s],r[i.charCodeAt(s)]=s;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var a=e.indexOf("=");return-1===a&&(a=t),[a,a===t?0:4-a%4]}function c(e,t,r){for(var n,i,s=[],o=t;o<r;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(a[(i=n)>>18&63]+a[i>>12&63]+a[i>>6&63]+a[63&i]);return s.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},729:e=>{"use strict";const t=/[\p{Lu}]/u,a=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,s=new RegExp("^"+i.source),o=new RegExp(i.source+n.source,"gu"),c=new RegExp("\\d+"+n.source,"gu"),l=(e,n)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(n={pascalCase:!1,preserveConsecutiveUppercase:!1,...n},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const i=!1===n.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(n.locale),l=!1===n.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(n.locale);return 1===e.length?n.pascalCase?l(e):i(e):(e!==i(e)&&(e=((e,r,n)=>{let i=!1,s=!1,o=!1;for(let c=0;c<e.length;c++){const l=e[c];i&&t.test(l)?(e=e.slice(0,c)+"-"+e.slice(c),i=!1,o=s,s=!0,c++):s&&o&&a.test(l)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=s,s=!1,i=!0):(i=r(l)===l&&n(l)!==l,o=s,s=n(l)===l&&r(l)!==l)}return e})(e,i,l)),e=e.replace(s,""),e=n.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(e,i):i(e),n.pascalCase&&(e=l(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,((e,a)=>t(a))).replace(c,(e=>t(e)))))(e,l))};e.exports=l,e.exports.default=l},478:e=>{"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,a="~";function r(){}function n(e,t,a){this.fn=e,this.context=t,this.once=a||!1}function i(e,t,r,i,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new n(r,i||e,s),c=a?a+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(a=!1)),o.prototype.eventNames=function(){var e,r,n=[];if(0===this._eventsCount)return n;for(r in e=this._events)t.call(e,r)&&n.push(a?r.slice(1):r);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=a?a+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,i=r.length,s=new Array(i);n<i;n++)s[n]=r[n].fn;return s},o.prototype.listenerCount=function(e){var t=a?a+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,n,i,s){var o=a?a+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,n),!0;case 5:return u.fn.call(u.context,t,r,n,i),!0;case 6:return u.fn.call(u.context,t,r,n,i,s),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,r);break;case 4:u[l].fn.call(u[l].context,t,r,n);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,a){return i(this,e,t,a,!1)},o.prototype.once=function(e,t,a){return i(this,e,t,a,!0)},o.prototype.removeListener=function(e,t,r,n){var i=a?a+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||n&&!o.once||r&&o.context!==r||s(this,i);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||n&&!o[c].once||r&&o[c].context!==r)&&l.push(o[c]);l.length?this._events[i]=1===l.length?l[0]:l:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=a?a+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=a,o.EventEmitter=o,e.exports=o},998:e=>{"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},290:(e,t,a)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=a(228),n=a(641),i=a(774),s=()=>{},o=new n.TimeoutError;t.default=class extends r{constructor(e){var t,a,r,n;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:i.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(a=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==a?a:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(n=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==n?n:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((a,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():n.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)}));a(await i)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},760:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,a){let r=0,n=e.length;for(;n>0;){const i=n/2|0;let s=r+i;a(e[s],t)<=0?(r=++s,n-=i+1):n=i}return r}},774:(e,t,a)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=a(760);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const a={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(a);const n=r.default(this._queue,a,((e,t)=>t.priority-e.priority));this._queue.splice(n,0,a)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},116:(e,t,a)=>{"use strict";const r=a(617),n=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class i extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t)=>new Promise(((a,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt((async r=>{try{a(await e(r))}catch(e){if(!(e instanceof Error))return void s(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof i)o.stop(),s(e.originalError);else if(e instanceof TypeError&&(c=e.message,!n.includes(c)))o.stop(),s(e);else{((e,t,a)=>{const r=a.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void s(e)}o.retry(e)||s(o.mainError())}}var c}))}));e.exports=s,e.exports.default=s,e.exports.AbortError=i},641:(e,t,a)=>{"use strict";const r=a(998);class n extends Error{constructor(e){super(e),this.name="TimeoutError"}}const i=(e,t,a)=>new Promise(((i,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void i(e);const o=setTimeout((()=>{if("function"==typeof a){try{i(a())}catch(e){s(e)}return}const r=a instanceof Error?a:new n("string"==typeof a?a:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(r)}),t);r(e.then(i,s),(()=>{clearTimeout(o)}))}));e.exports=i,e.exports.default=i,e.exports.TimeoutError=n},617:(e,t,a)=>{e.exports=a(303)},303:(e,t,a)=>{var r=a(961);t.operation=function(e){var a=t.timeouts(e);return new r(a,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var a in e)t[a]=e[a];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],n=0;n<t.retries;n++)r.push(this.createTimeout(n,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(n,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var a=t.randomize?Math.random()+1:1,r=Math.round(a*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,a,r){if(a instanceof Array&&(r=a,a=null),!r)for(var n in r=[],e)"function"==typeof e[n]&&r.push(n);for(var i=0;i<r.length;i++){var s=r[i],o=e[s];e[s]=function(r){var n=t.operation(a),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){n.retry(e)||(e&&(arguments[0]=n.mainError()),s.apply(this,arguments))})),n.attempt((function(){r.apply(e,i)}))}.bind(e,o),e[s].options=a}}},961:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var a=this._timeouts.shift();if(void 0===a){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),a=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),a),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var a=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){a._operationTimeoutCb()}),a._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,a=0,r=0;r<this._errors.length;r++){var n=this._errors[r],i=n.message,s=(e[i]||0)+1;e[i]=s,s>=a&&(t=n,a=s)}return t}}},t={};function a(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={id:r,loaded:!1,exports:{}};return e[r](i,i.exports,a),i.loaded=!0,i.exports}a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{"use strict";var e={};function t(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const a=[];let r=!1,n=!1;for(let i of e){if(r)'"'!==i||n?"\n"!==i||n?n="\\"===i&&!n:i="\\n":r=!1;else if('"'===i)r=!0,n=!1;else if("{"===i)a.push("}");else if("["===i)a.push("]");else if("}"===i||"]"===i){if(!a||a[a.length-1]!==i)return null;a.pop()}t+=i}r&&(t+='"');for(let e=a.length-1;e>=0;e-=1)t+=a[e];try{return JSON.parse(t)}catch(e){return null}}a.r(e),a.d(e,{JsonPatchError:()=>er,_areEquals:()=>ur,applyOperation:()=>ir,applyPatch:()=>sr,applyReducer:()=>or,deepClone:()=>tr,getValueByPointer:()=>nr,validate:()=>lr,validator:()=>cr});var r,n,i=a(478);function s(e,t){return t?.[e]||i(e)}function o(e,t,a){const r={};for(const n in e)Object.hasOwn(e,n)&&(r[t(n,a)]=e[n]);return r}function c(e){return Array.isArray(e)?[...e]:{...e}}function l(e,t){const a=c(e);for(const[e,r]of Object.entries(t)){const[t,...n]=e.split(".").reverse();let i=a;for(const e of n.reverse()){if(void 0===i[e])break;i[e]=c(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[r]})}return a}function u(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}a(729);class d{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,u(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof d||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},a=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(a,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=a;const[n,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}n in t&&void 0!==t[n]&&(r[n]=r[n]||t[n])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:o(Object.keys(t).length?l(a,t):a,s,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}class h extends d{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function p(e,t){const a={...e};for(const[e,r]of Object.entries(t))if(null==a[e])a[e]=r;else{if(null==r)continue;if(typeof a[e]!=typeof r||Array.isArray(a[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof a[e])a[e]=a[e]+r;else if(Array.isArray(a[e])||"object"!=typeof a[e])if(Array.isArray(a[e]))a[e]=m(a[e],r);else{if(a[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else a[e]=p(a[e],r)}return a}function m(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const a=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=a.findIndex((t=>t.index===e.index));-1!==t?a[t]=p(a[t],e):a.push(e)}else a.push(e);return a}}}class f extends h{}class g extends h{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let a;if("string"==typeof e)a={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{a=e;const t=a.additional_kwargs?.tool_calls,r=a.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],a=[];for(const r of e)if(r.function){const e=r.function.name;try{const a={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(a)}catch(t){a.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,a]}(t);a.tool_calls=e??[],a.invalid_tool_calls=r??[]}else a.tool_calls=a.tool_calls??[],a.invalid_tool_calls=a.invalid_tool_calls??[]}catch(e){a.tool_calls=[],a.invalid_tool_calls=[]}}super(a),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof a&&(this.tool_calls=a.tool_calls??this.tool_calls,this.invalid_tool_calls=a.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=a.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}}class y extends f{constructor(e){let a;if("string"==typeof e)a={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)a={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{const r=[],n=[];for(const a of e.tool_call_chunks){let e={};try{if(e=t(a.args??"{}")??{},"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");r.push({name:a.name??"",args:e,id:a.id})}catch(e){n.push({name:a.name,args:a.args,id:a.id,error:"Malformed args."})}}a={...e,tool_calls:r,invalid_tool_calls:n}}super(a),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=a.tool_call_chunks??this.tool_call_chunks,this.tool_calls=a.tool_calls??this.tool_calls,this.invalid_tool_calls=a.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=a.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:(a=this.content,r=e.content,"string"==typeof a?"string"==typeof r?a+r:[{type:"text",text:a},...r]:Array.isArray(r)?[...a,...r]:[...a,{type:"text",text:r}]),additional_kwargs:p(this.additional_kwargs,e.additional_kwargs),response_metadata:p(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};var a,r;if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const a=m(this.tool_call_chunks,e.tool_call_chunks);void 0!==a&&a.length>0&&(t.tool_call_chunks=a)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const a=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},r=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},n={input_tokens:a.input_tokens+r.input_tokens,output_tokens:a.output_tokens+r.output_tokens,total_tokens:a.total_tokens+r.total_tokens};t.usage_metadata=n}return new y(t)}}class b extends h{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class v extends h{static lc_name(){return"SystemMessage"}_getType(){return"system"}}function _(e){const{type:t,...a}=e;if("human"===t||"user"===t)return new b(a);if("ai"===t||"assistant"===t)return new g(a);if("system"===t)return new v(a);throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function w(e){if("string"==typeof e)return new b(e);if(function(e){return"function"==typeof e?._getType}(e))return e;if(Array.isArray(e)){const[t,a]=e;return _({type:t,content:a})}return _(e)}function k(e,t="Human",a="AI"){const r=[];for(const n of e){let e;if("human"===n._getType())e=t;else if("ai"===n._getType())e=a;else if("system"===n._getType())e="System";else if("function"===n._getType())e="Function";else if("tool"===n._getType())e="Tool";else{if("generic"!==n._getType())throw new Error(`Got unsupported message type: ${n._getType()}`);e=n.role}const i=n.name?`${n.name}, `:"";r.push(`${e}: ${i}${n.content}`)}return r.join("\n")}!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const a of e)t[a]=a;return t},e.getValidEnumValues=t=>{const a=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of a)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.push(a);return t},e.find=(e,t)=>{for(const a of e)if(t(a))return a},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(r||(r={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(n||(n={}));const O=r.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),x=e=>{switch(typeof e){case"undefined":return O.undefined;case"string":return O.string;case"number":return isNaN(e)?O.nan:O.number;case"boolean":return O.boolean;case"function":return O.function;case"bigint":return O.bigint;case"symbol":return O.symbol;case"object":return Array.isArray(e)?O.array:null===e?O.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?O.promise:"undefined"!=typeof Map&&e instanceof Map?O.map:"undefined"!=typeof Set&&e instanceof Set?O.set:"undefined"!=typeof Date&&e instanceof Date?O.date:O.object;default:return O.unknown}},T=r.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class E extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},a={_errors:[]},r=e=>{for(const n of e.issues)if("invalid_union"===n.code)n.unionErrors.map(r);else if("invalid_return_type"===n.code)r(n.returnTypeError);else if("invalid_arguments"===n.code)r(n.argumentsError);else if(0===n.path.length)a._errors.push(t(n));else{let e=a,r=0;for(;r<n.path.length;){const a=n.path[r];r===n.path.length-1?(e[a]=e[a]||{_errors:[]},e[a]._errors.push(t(n))):e[a]=e[a]||{_errors:[]},e=e[a],r++}}};return r(this),a}static assert(e){if(!(e instanceof E))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,r.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=(e=>e.message)){const t={},a=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):a.push(e(r));return{formErrors:a,fieldErrors:t}}get formErrors(){return this.flatten()}}E.create=e=>new E(e);const P=(e,t)=>{let a;switch(e.code){case T.invalid_type:a=e.received===O.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case T.invalid_literal:a=`Invalid literal value, expected ${JSON.stringify(e.expected,r.jsonStringifyReplacer)}`;break;case T.unrecognized_keys:a=`Unrecognized key(s) in object: ${r.joinValues(e.keys,", ")}`;break;case T.invalid_union:a="Invalid input";break;case T.invalid_union_discriminator:a=`Invalid discriminator value. Expected ${r.joinValues(e.options)}`;break;case T.invalid_enum_value:a=`Invalid enum value. Expected ${r.joinValues(e.options)}, received '${e.received}'`;break;case T.invalid_arguments:a="Invalid function arguments";break;case T.invalid_return_type:a="Invalid function return type";break;case T.invalid_date:a="Invalid date";break;case T.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(a=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(a=`${a} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?a=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?a=`Invalid input: must end with "${e.validation.endsWith}"`:r.assertNever(e.validation):a="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case T.too_small:a="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case T.too_big:a="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case T.custom:a="Invalid input";break;case T.invalid_intersection_types:a="Intersection results could not be merged";break;case T.not_multiple_of:a=`Number must be a multiple of ${e.multipleOf}`;break;case T.not_finite:a="Number must be finite";break;default:a=t.defaultError,r.assertNever(e)}return{message:a}};let I=P;function j(){return I}const S=e=>{const{data:t,path:a,errorMaps:r,issueData:n}=e,i=[...a,...n.path||[]],s={...n,path:i};if(void 0!==n.message)return{...n,path:i,message:n.message};let o="";const c=r.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(s,{data:t,defaultError:o}).message;return{...n,path:i,message:o}};function A(e,t){const a=j(),r=S({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,a,a===P?void 0:P].filter((e=>!!e))});e.common.issues.push(r)}class N{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const a=[];for(const r of t){if("aborted"===r.status)return C;"dirty"===r.status&&e.dirty(),a.push(r.value)}return{status:e.value,value:a}}static async mergeObjectAsync(e,t){const a=[];for(const e of t){const t=await e.key,r=await e.value;a.push({key:t,value:r})}return N.mergeObjectSync(e,a)}static mergeObjectSync(e,t){const a={};for(const r of t){const{key:t,value:n}=r;if("aborted"===t.status)return C;if("aborted"===n.status)return C;"dirty"===t.status&&e.dirty(),"dirty"===n.status&&e.dirty(),"__proto__"===t.value||void 0===n.value&&!r.alwaysSet||(a[t.value]=n.value)}return{status:e.value,value:a}}}const C=Object.freeze({status:"aborted"}),R=e=>({status:"dirty",value:e}),$=e=>({status:"valid",value:e}),L=e=>"aborted"===e.status,M=e=>"dirty"===e.status,Z=e=>"valid"===e.status,D=e=>"undefined"!=typeof Promise&&e instanceof Promise;function U(e,t,a,r){if("a"===a&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===a?r:"a"===a?r.call(e):r?r.value:t.get(e)}function B(e,t,a,r,n){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?n.call(e,a):n?n.value=a:t.set(e,a),a}var F,z,H;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(F||(F={}));class q{constructor(e,t,a,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=a,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const V=(e,t)=>{if(Z(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new E(e.common.issues);return this._error=t,this._error}}};function G(e){if(!e)return{};const{errorMap:t,invalid_type_error:a,required_error:r,description:n}=e;if(t&&(a||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:n}:{errorMap:(t,n)=>{var i,s;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:n.defaultError}:void 0===n.data?{message:null!==(i=null!=o?o:r)&&void 0!==i?i:n.defaultError}:"invalid_type"!==t.code?{message:n.defaultError}:{message:null!==(s=null!=o?o:a)&&void 0!==s?s:n.defaultError}},description:n}}class J{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return x(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:x(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new N,ctx:{common:e.parent.common,data:e.data,parsedType:x(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(D(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const a=this.safeParse(e,t);if(a.success)return a.data;throw a.error}safeParse(e,t){var a;const r={common:{issues:[],async:null!==(a=null==t?void 0:t.async)&&void 0!==a&&a,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:x(e)},n=this._parseSync({data:e,path:r.path,parent:r});return V(r,n)}async parseAsync(e,t){const a=await this.safeParseAsync(e,t);if(a.success)return a.data;throw a.error}async safeParseAsync(e,t){const a={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:x(e)},r=this._parse({data:e,path:a.path,parent:a}),n=await(D(r)?r:Promise.resolve(r));return V(a,n)}refine(e,t){const a=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const n=e(t),i=()=>r.addIssue({code:T.custom,...a(t)});return"undefined"!=typeof Promise&&n instanceof Promise?n.then((e=>!!e||(i(),!1))):!!n||(i(),!1)}))}refinement(e,t){return this._refinement(((a,r)=>!!e(a)||(r.addIssue("function"==typeof t?t(a,r):t),!1)))}_refinement(e){return new Fe({schema:this,typeName:et.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return ze.create(this,this._def)}nullable(){return He.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Oe.create(this,this._def)}promise(){return Be.create(this,this._def)}or(e){return Ee.create([this,e],this._def)}and(e){return Se.create(this,e,this._def)}transform(e){return new Fe({...G(this._def),schema:this,typeName:et.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new qe({...G(this._def),innerType:this,defaultValue:t,typeName:et.ZodDefault})}brand(){return new Ke({typeName:et.ZodBranded,type:this,...G(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new Ve({...G(this._def),innerType:this,catchValue:t,typeName:et.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return We.create(this,e)}readonly(){return Qe.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const K=/^c[^\s-]{8,}$/i,W=/^[0-9a-z]+$/,Q=/^[0-9A-HJKMNP-TV-Z]{26}$/,Y=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,X=/^[a-z0-9_-]{21}$/i,ee=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,te=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let ae;const re=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ne=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ie=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,se="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",oe=new RegExp(`^${se}$`);function ce(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function le(e){let t=`${se}T${ce(e)}`;const a=[];return a.push(e.local?"Z?":"Z"),e.offset&&a.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${a.join("|")})`,new RegExp(`^${t}$`)}class ue extends J{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==O.string){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.string,received:t.parsedType}),C}const t=new N;let a;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:T.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:T.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,n=e.data.length<s.value;(r||n)&&(a=this._getOrReturnCtx(e,a),r?A(a,{code:T.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):n&&A(a,{code:T.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)te.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"email",code:T.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)ae||(ae=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ae.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"emoji",code:T.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)Y.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"uuid",code:T.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)X.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"nanoid",code:T.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)K.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid",code:T.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)W.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid2",code:T.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)Q.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ulid",code:T.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch(r){a=this._getOrReturnCtx(e,a),A(a,{validation:"url",code:T.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"regex",code:T.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),A(a,{code:T.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:T.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:T.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?le(s).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:T.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?oe.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:T.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?new RegExp(`^${ce(s)}$`).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:T.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?ee.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"duration",code:T.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?(n=e.data,("v4"!==(i=s.version)&&i||!re.test(n))&&("v6"!==i&&i||!ne.test(n))&&(a=this._getOrReturnCtx(e,a),A(a,{validation:"ip",code:T.invalid_string,message:s.message}),t.dirty())):"base64"===s.kind?ie.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"base64",code:T.invalid_string,message:s.message}),t.dirty()):r.assertNever(s);var n,i;return{status:t.value,value:e.data}}_regex(e,t,a){return this.refinement((t=>e.test(t)),{validation:t,code:T.invalid_string,...F.errToObj(a)})}_addCheck(e){return new ue({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...F.errToObj(e)})}url(e){return this._addCheck({kind:"url",...F.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...F.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...F.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...F.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...F.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...F.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...F.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...F.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...F.errToObj(e)})}datetime(e){var t,a;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(a=null==e?void 0:e.local)&&void 0!==a&&a,...F.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...F.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...F.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...F.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...F.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...F.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...F.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...F.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...F.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...F.errToObj(t)})}nonempty(e){return this.min(1,F.errToObj(e))}trim(){return new ue({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ue({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ue({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function de(e,t){const a=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,n=a>r?a:r;return parseInt(e.toFixed(n).replace(".",""))%parseInt(t.toFixed(n).replace(".",""))/Math.pow(10,n)}ue.create=e=>{var t;return new ue({checks:[],typeName:et.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...G(e)})};class he extends J{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==O.number){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.number,received:t.parsedType}),C}let t;const a=new N;for(const n of this._def.checks)"int"===n.kind?r.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),A(t,{code:T.invalid_type,expected:"integer",received:"float",message:n.message}),a.dirty()):"min"===n.kind?(n.inclusive?e.data<n.value:e.data<=n.value)&&(t=this._getOrReturnCtx(e,t),A(t,{code:T.too_small,minimum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),a.dirty()):"max"===n.kind?(n.inclusive?e.data>n.value:e.data>=n.value)&&(t=this._getOrReturnCtx(e,t),A(t,{code:T.too_big,maximum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),a.dirty()):"multipleOf"===n.kind?0!==de(e.data,n.value)&&(t=this._getOrReturnCtx(e,t),A(t,{code:T.not_multiple_of,multipleOf:n.value,message:n.message}),a.dirty()):"finite"===n.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),A(t,{code:T.not_finite,message:n.message}),a.dirty()):r.assertNever(n);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,F.toString(t))}gt(e,t){return this.setLimit("min",e,!1,F.toString(t))}lte(e,t){return this.setLimit("max",e,!0,F.toString(t))}lt(e,t){return this.setLimit("max",e,!1,F.toString(t))}setLimit(e,t,a,r){return new he({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:a,message:F.toString(r)}]})}_addCheck(e){return new he({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:F.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:F.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:F.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:F.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:F.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:F.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:F.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:F.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:F.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&r.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const a of this._def.checks){if("finite"===a.kind||"int"===a.kind||"multipleOf"===a.kind)return!0;"min"===a.kind?(null===t||a.value>t)&&(t=a.value):"max"===a.kind&&(null===e||a.value<e)&&(e=a.value)}return Number.isFinite(t)&&Number.isFinite(e)}}he.create=e=>new he({checks:[],typeName:et.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...G(e)});class pe extends J{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==O.bigint){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.bigint,received:t.parsedType}),C}let t;const a=new N;for(const n of this._def.checks)"min"===n.kind?(n.inclusive?e.data<n.value:e.data<=n.value)&&(t=this._getOrReturnCtx(e,t),A(t,{code:T.too_small,type:"bigint",minimum:n.value,inclusive:n.inclusive,message:n.message}),a.dirty()):"max"===n.kind?(n.inclusive?e.data>n.value:e.data>=n.value)&&(t=this._getOrReturnCtx(e,t),A(t,{code:T.too_big,type:"bigint",maximum:n.value,inclusive:n.inclusive,message:n.message}),a.dirty()):"multipleOf"===n.kind?e.data%n.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),A(t,{code:T.not_multiple_of,multipleOf:n.value,message:n.message}),a.dirty()):r.assertNever(n);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,F.toString(t))}gt(e,t){return this.setLimit("min",e,!1,F.toString(t))}lte(e,t){return this.setLimit("max",e,!0,F.toString(t))}lt(e,t){return this.setLimit("max",e,!1,F.toString(t))}setLimit(e,t,a,r){return new pe({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:a,message:F.toString(r)}]})}_addCheck(e){return new pe({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:F.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:F.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:F.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:F.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:F.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}pe.create=e=>{var t;return new pe({checks:[],typeName:et.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...G(e)})};class me extends J{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==O.boolean){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.boolean,received:t.parsedType}),C}return $(e.data)}}me.create=e=>new me({typeName:et.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...G(e)});class fe extends J{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==O.date){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.date,received:t.parsedType}),C}if(isNaN(e.data.getTime()))return A(this._getOrReturnCtx(e),{code:T.invalid_date}),C;const t=new N;let a;for(const n of this._def.checks)"min"===n.kind?e.data.getTime()<n.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:T.too_small,message:n.message,inclusive:!0,exact:!1,minimum:n.value,type:"date"}),t.dirty()):"max"===n.kind?e.data.getTime()>n.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:T.too_big,message:n.message,inclusive:!0,exact:!1,maximum:n.value,type:"date"}),t.dirty()):r.assertNever(n);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new fe({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:F.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:F.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}fe.create=e=>new fe({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:et.ZodDate,...G(e)});class ge extends J{_parse(e){if(this._getType(e)!==O.symbol){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.symbol,received:t.parsedType}),C}return $(e.data)}}ge.create=e=>new ge({typeName:et.ZodSymbol,...G(e)});class ye extends J{_parse(e){if(this._getType(e)!==O.undefined){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.undefined,received:t.parsedType}),C}return $(e.data)}}ye.create=e=>new ye({typeName:et.ZodUndefined,...G(e)});class be extends J{_parse(e){if(this._getType(e)!==O.null){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.null,received:t.parsedType}),C}return $(e.data)}}be.create=e=>new be({typeName:et.ZodNull,...G(e)});class ve extends J{constructor(){super(...arguments),this._any=!0}_parse(e){return $(e.data)}}ve.create=e=>new ve({typeName:et.ZodAny,...G(e)});class _e extends J{constructor(){super(...arguments),this._unknown=!0}_parse(e){return $(e.data)}}_e.create=e=>new _e({typeName:et.ZodUnknown,...G(e)});class we extends J{_parse(e){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.never,received:t.parsedType}),C}}we.create=e=>new we({typeName:et.ZodNever,...G(e)});class ke extends J{_parse(e){if(this._getType(e)!==O.undefined){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.void,received:t.parsedType}),C}return $(e.data)}}ke.create=e=>new ke({typeName:et.ZodVoid,...G(e)});class Oe extends J{_parse(e){const{ctx:t,status:a}=this._processInputParams(e),r=this._def;if(t.parsedType!==O.array)return A(t,{code:T.invalid_type,expected:O.array,received:t.parsedType}),C;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,n=t.data.length<r.exactLength.value;(e||n)&&(A(t,{code:e?T.too_big:T.too_small,minimum:n?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),a.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(A(t,{code:T.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),a.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(A(t,{code:T.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),a.dirty()),t.common.async)return Promise.all([...t.data].map(((e,a)=>r.type._parseAsync(new q(t,e,t.path,a))))).then((e=>N.mergeArray(a,e)));const n=[...t.data].map(((e,a)=>r.type._parseSync(new q(t,e,t.path,a))));return N.mergeArray(a,n)}get element(){return this._def.type}min(e,t){return new Oe({...this._def,minLength:{value:e,message:F.toString(t)}})}max(e,t){return new Oe({...this._def,maxLength:{value:e,message:F.toString(t)}})}length(e,t){return new Oe({...this._def,exactLength:{value:e,message:F.toString(t)}})}nonempty(e){return this.min(1,e)}}function xe(e){if(e instanceof Te){const t={};for(const a in e.shape){const r=e.shape[a];t[a]=ze.create(xe(r))}return new Te({...e._def,shape:()=>t})}return e instanceof Oe?new Oe({...e._def,type:xe(e.element)}):e instanceof ze?ze.create(xe(e.unwrap())):e instanceof He?He.create(xe(e.unwrap())):e instanceof Ae?Ae.create(e.items.map((e=>xe(e)))):e}Oe.create=(e,t)=>new Oe({type:e,minLength:null,maxLength:null,exactLength:null,typeName:et.ZodArray,...G(t)});class Te extends J{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=r.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==O.object){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.object,received:t.parsedType}),C}const{status:t,ctx:a}=this._processInputParams(e),{shape:r,keys:n}=this._getCached(),i=[];if(!(this._def.catchall instanceof we&&"strip"===this._def.unknownKeys))for(const e in a.data)n.includes(e)||i.push(e);const s=[];for(const e of n){const t=r[e],n=a.data[e];s.push({key:{status:"valid",value:e},value:t._parse(new q(a,n,a.path,e)),alwaysSet:e in a.data})}if(this._def.catchall instanceof we){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of i)s.push({key:{status:"valid",value:e},value:{status:"valid",value:a.data[e]}});else if("strict"===e)i.length>0&&(A(a,{code:T.unrecognized_keys,keys:i}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of i){const r=a.data[t];s.push({key:{status:"valid",value:t},value:e._parse(new q(a,r,a.path,t)),alwaysSet:t in a.data})}}return a.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of s){const a=await t.key,r=await t.value;e.push({key:a,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>N.mergeObjectSync(t,e))):N.mergeObjectSync(t,s)}get shape(){return this._def.shape()}strict(e){return F.errToObj,new Te({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,a)=>{var r,n,i,s;const o=null!==(i=null===(n=(r=this._def).errorMap)||void 0===n?void 0:n.call(r,t,a).message)&&void 0!==i?i:a.defaultError;return"unrecognized_keys"===t.code?{message:null!==(s=F.errToObj(e).message)&&void 0!==s?s:o}:{message:o}}}:{}})}strip(){return new Te({...this._def,unknownKeys:"strip"})}passthrough(){return new Te({...this._def,unknownKeys:"passthrough"})}extend(e){return new Te({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Te({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:et.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Te({...this._def,catchall:e})}pick(e){const t={};return r.objectKeys(e).forEach((a=>{e[a]&&this.shape[a]&&(t[a]=this.shape[a])})),new Te({...this._def,shape:()=>t})}omit(e){const t={};return r.objectKeys(this.shape).forEach((a=>{e[a]||(t[a]=this.shape[a])})),new Te({...this._def,shape:()=>t})}deepPartial(){return xe(this)}partial(e){const t={};return r.objectKeys(this.shape).forEach((a=>{const r=this.shape[a];e&&!e[a]?t[a]=r:t[a]=r.optional()})),new Te({...this._def,shape:()=>t})}required(e){const t={};return r.objectKeys(this.shape).forEach((a=>{if(e&&!e[a])t[a]=this.shape[a];else{let e=this.shape[a];for(;e instanceof ze;)e=e._def.innerType;t[a]=e}})),new Te({...this._def,shape:()=>t})}keyof(){return Ze(r.objectKeys(this.shape))}}Te.create=(e,t)=>new Te({shape:()=>e,unknownKeys:"strip",catchall:we.create(),typeName:et.ZodObject,...G(t)}),Te.strictCreate=(e,t)=>new Te({shape:()=>e,unknownKeys:"strict",catchall:we.create(),typeName:et.ZodObject,...G(t)}),Te.lazycreate=(e,t)=>new Te({shape:e,unknownKeys:"strip",catchall:we.create(),typeName:et.ZodObject,...G(t)});class Ee extends J{_parse(e){const{ctx:t}=this._processInputParams(e),a=this._def.options;if(t.common.async)return Promise.all(a.map((async e=>{const a={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:a}),ctx:a}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const a of e)if("dirty"===a.result.status)return t.common.issues.push(...a.ctx.common.issues),a.result;const a=e.map((e=>new E(e.ctx.common.issues)));return A(t,{code:T.invalid_union,unionErrors:a}),C}));{let e;const r=[];for(const n of a){const a={...t,common:{...t.common,issues:[]},parent:null},i=n._parseSync({data:t.data,path:t.path,parent:a});if("valid"===i.status)return i;"dirty"!==i.status||e||(e={result:i,ctx:a}),a.common.issues.length&&r.push(a.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const n=r.map((e=>new E(e)));return A(t,{code:T.invalid_union,unionErrors:n}),C}}get options(){return this._def.options}}Ee.create=(e,t)=>new Ee({options:e,typeName:et.ZodUnion,...G(t)});const Pe=e=>e instanceof Le?Pe(e.schema):e instanceof Fe?Pe(e.innerType()):e instanceof Me?[e.value]:e instanceof De?e.options:e instanceof Ue?r.objectValues(e.enum):e instanceof qe?Pe(e._def.innerType):e instanceof ye?[void 0]:e instanceof be?[null]:e instanceof ze?[void 0,...Pe(e.unwrap())]:e instanceof He?[null,...Pe(e.unwrap())]:e instanceof Ke||e instanceof Qe?Pe(e.unwrap()):e instanceof Ve?Pe(e._def.innerType):[];class Ie extends J{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.object)return A(t,{code:T.invalid_type,expected:O.object,received:t.parsedType}),C;const a=this.discriminator,r=t.data[a],n=this.optionsMap.get(r);return n?t.common.async?n._parseAsync({data:t.data,path:t.path,parent:t}):n._parseSync({data:t.data,path:t.path,parent:t}):(A(t,{code:T.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[a]}),C)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,a){const r=new Map;for(const a of t){const t=Pe(a.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const n of t){if(r.has(n))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(n)}`);r.set(n,a)}}return new Ie({typeName:et.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...G(a)})}}function je(e,t){const a=x(e),n=x(t);if(e===t)return{valid:!0,data:e};if(a===O.object&&n===O.object){const a=r.objectKeys(t),n=r.objectKeys(e).filter((e=>-1!==a.indexOf(e))),i={...e,...t};for(const a of n){const r=je(e[a],t[a]);if(!r.valid)return{valid:!1};i[a]=r.data}return{valid:!0,data:i}}if(a===O.array&&n===O.array){if(e.length!==t.length)return{valid:!1};const a=[];for(let r=0;r<e.length;r++){const n=je(e[r],t[r]);if(!n.valid)return{valid:!1};a.push(n.data)}return{valid:!0,data:a}}return a===O.date&&n===O.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class Se extends J{_parse(e){const{status:t,ctx:a}=this._processInputParams(e),r=(e,r)=>{if(L(e)||L(r))return C;const n=je(e.value,r.value);return n.valid?((M(e)||M(r))&&t.dirty(),{status:t.value,value:n.data}):(A(a,{code:T.invalid_intersection_types}),C)};return a.common.async?Promise.all([this._def.left._parseAsync({data:a.data,path:a.path,parent:a}),this._def.right._parseAsync({data:a.data,path:a.path,parent:a})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:a.data,path:a.path,parent:a}),this._def.right._parseSync({data:a.data,path:a.path,parent:a}))}}Se.create=(e,t,a)=>new Se({left:e,right:t,typeName:et.ZodIntersection,...G(a)});class Ae extends J{_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==O.array)return A(a,{code:T.invalid_type,expected:O.array,received:a.parsedType}),C;if(a.data.length<this._def.items.length)return A(a,{code:T.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),C;!this._def.rest&&a.data.length>this._def.items.length&&(A(a,{code:T.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...a.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new q(a,e,a.path,t)):null})).filter((e=>!!e));return a.common.async?Promise.all(r).then((e=>N.mergeArray(t,e))):N.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Ae({...this._def,rest:e})}}Ae.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ae({items:e,typeName:et.ZodTuple,rest:null,...G(t)})};class Ne extends J{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==O.object)return A(a,{code:T.invalid_type,expected:O.object,received:a.parsedType}),C;const r=[],n=this._def.keyType,i=this._def.valueType;for(const e in a.data)r.push({key:n._parse(new q(a,e,a.path,e)),value:i._parse(new q(a,a.data[e],a.path,e)),alwaysSet:e in a.data});return a.common.async?N.mergeObjectAsync(t,r):N.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,a){return new Ne(t instanceof J?{keyType:e,valueType:t,typeName:et.ZodRecord,...G(a)}:{keyType:ue.create(),valueType:e,typeName:et.ZodRecord,...G(t)})}}class Ce extends J{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==O.map)return A(a,{code:T.invalid_type,expected:O.map,received:a.parsedType}),C;const r=this._def.keyType,n=this._def.valueType,i=[...a.data.entries()].map((([e,t],i)=>({key:r._parse(new q(a,e,a.path,[i,"key"])),value:n._parse(new q(a,t,a.path,[i,"value"]))})));if(a.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const a of i){const r=await a.key,n=await a.value;if("aborted"===r.status||"aborted"===n.status)return C;"dirty"!==r.status&&"dirty"!==n.status||t.dirty(),e.set(r.value,n.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const a of i){const r=a.key,n=a.value;if("aborted"===r.status||"aborted"===n.status)return C;"dirty"!==r.status&&"dirty"!==n.status||t.dirty(),e.set(r.value,n.value)}return{status:t.value,value:e}}}}Ce.create=(e,t,a)=>new Ce({valueType:t,keyType:e,typeName:et.ZodMap,...G(a)});class Re extends J{_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==O.set)return A(a,{code:T.invalid_type,expected:O.set,received:a.parsedType}),C;const r=this._def;null!==r.minSize&&a.data.size<r.minSize.value&&(A(a,{code:T.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&a.data.size>r.maxSize.value&&(A(a,{code:T.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const n=this._def.valueType;function i(e){const a=new Set;for(const r of e){if("aborted"===r.status)return C;"dirty"===r.status&&t.dirty(),a.add(r.value)}return{status:t.value,value:a}}const s=[...a.data.values()].map(((e,t)=>n._parse(new q(a,e,a.path,t))));return a.common.async?Promise.all(s).then((e=>i(e))):i(s)}min(e,t){return new Re({...this._def,minSize:{value:e,message:F.toString(t)}})}max(e,t){return new Re({...this._def,maxSize:{value:e,message:F.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Re.create=(e,t)=>new Re({valueType:e,minSize:null,maxSize:null,typeName:et.ZodSet,...G(t)});class $e extends J{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.function)return A(t,{code:T.invalid_type,expected:O.function,received:t.parsedType}),C;function a(e,a){return S({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,j(),P].filter((e=>!!e)),issueData:{code:T.invalid_arguments,argumentsError:a}})}function r(e,a){return S({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,j(),P].filter((e=>!!e)),issueData:{code:T.invalid_return_type,returnTypeError:a}})}const n={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Be){const e=this;return $((async function(...t){const s=new E([]),o=await e._def.args.parseAsync(t,n).catch((e=>{throw s.addIssue(a(t,e)),s})),c=await Reflect.apply(i,this,o);return await e._def.returns._def.type.parseAsync(c,n).catch((e=>{throw s.addIssue(r(c,e)),s}))}))}{const e=this;return $((function(...t){const s=e._def.args.safeParse(t,n);if(!s.success)throw new E([a(t,s.error)]);const o=Reflect.apply(i,this,s.data),c=e._def.returns.safeParse(o,n);if(!c.success)throw new E([r(o,c.error)]);return c.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new $e({...this._def,args:Ae.create(e).rest(_e.create())})}returns(e){return new $e({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,a){return new $e({args:e||Ae.create([]).rest(_e.create()),returns:t||_e.create(),typeName:et.ZodFunction,...G(a)})}}class Le extends J{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Le.create=(e,t)=>new Le({getter:e,typeName:et.ZodLazy,...G(t)});class Me extends J{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return A(t,{received:t.data,code:T.invalid_literal,expected:this._def.value}),C}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Ze(e,t){return new De({values:e,typeName:et.ZodEnum,...G(t)})}Me.create=(e,t)=>new Me({value:e,typeName:et.ZodLiteral,...G(t)});class De extends J{constructor(){super(...arguments),z.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),a=this._def.values;return A(t,{expected:r.joinValues(a),received:t.parsedType,code:T.invalid_type}),C}if(U(this,z,"f")||B(this,z,new Set(this._def.values),"f"),!U(this,z,"f").has(e.data)){const t=this._getOrReturnCtx(e),a=this._def.values;return A(t,{received:t.data,code:T.invalid_enum_value,options:a}),C}return $(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return De.create(e,{...this._def,...t})}exclude(e,t=this._def){return De.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}z=new WeakMap,De.create=Ze;class Ue extends J{constructor(){super(...arguments),H.set(this,void 0)}_parse(e){const t=r.getValidEnumValues(this._def.values),a=this._getOrReturnCtx(e);if(a.parsedType!==O.string&&a.parsedType!==O.number){const e=r.objectValues(t);return A(a,{expected:r.joinValues(e),received:a.parsedType,code:T.invalid_type}),C}if(U(this,H,"f")||B(this,H,new Set(r.getValidEnumValues(this._def.values)),"f"),!U(this,H,"f").has(e.data)){const e=r.objectValues(t);return A(a,{received:a.data,code:T.invalid_enum_value,options:e}),C}return $(e.data)}get enum(){return this._def.values}}H=new WeakMap,Ue.create=(e,t)=>new Ue({values:e,typeName:et.ZodNativeEnum,...G(t)});class Be extends J{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.promise&&!1===t.common.async)return A(t,{code:T.invalid_type,expected:O.promise,received:t.parsedType}),C;const a=t.parsedType===O.promise?t.data:Promise.resolve(t.data);return $(a.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}Be.create=(e,t)=>new Be({type:e,typeName:et.ZodPromise,...G(t)});class Fe extends J{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===et.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:a}=this._processInputParams(e),n=this._def.effect||null,i={addIssue:e=>{A(a,e),e.fatal?t.abort():t.dirty()},get path(){return a.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===n.type){const e=n.transform(a.data,i);if(a.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return C;const r=await this._def.schema._parseAsync({data:e,path:a.path,parent:a});return"aborted"===r.status?C:"dirty"===r.status||"dirty"===t.value?R(r.value):r}));{if("aborted"===t.value)return C;const r=this._def.schema._parseSync({data:e,path:a.path,parent:a});return"aborted"===r.status?C:"dirty"===r.status||"dirty"===t.value?R(r.value):r}}if("refinement"===n.type){const e=e=>{const t=n.refinement(e,i);if(a.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===a.common.async){const r=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});return"aborted"===r.status?C:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then((a=>"aborted"===a.status?C:("dirty"===a.status&&t.dirty(),e(a.value).then((()=>({status:t.value,value:a.value}))))))}if("transform"===n.type){if(!1===a.common.async){const e=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});if(!Z(e))return e;const r=n.transform(e.value,i);if(r instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:r}}return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then((e=>Z(e)?Promise.resolve(n.transform(e.value,i)).then((e=>({status:t.value,value:e}))):e))}r.assertNever(n)}}Fe.create=(e,t,a)=>new Fe({schema:e,typeName:et.ZodEffects,effect:t,...G(a)}),Fe.createWithPreprocess=(e,t,a)=>new Fe({schema:t,effect:{type:"preprocess",transform:e},typeName:et.ZodEffects,...G(a)});class ze extends J{_parse(e){return this._getType(e)===O.undefined?$(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ze.create=(e,t)=>new ze({innerType:e,typeName:et.ZodOptional,...G(t)});class He extends J{_parse(e){return this._getType(e)===O.null?$(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}He.create=(e,t)=>new He({innerType:e,typeName:et.ZodNullable,...G(t)});class qe extends J{_parse(e){const{ctx:t}=this._processInputParams(e);let a=t.data;return t.parsedType===O.undefined&&(a=this._def.defaultValue()),this._def.innerType._parse({data:a,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}qe.create=(e,t)=>new qe({innerType:e,typeName:et.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...G(t)});class Ve extends J{_parse(e){const{ctx:t}=this._processInputParams(e),a={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:a.data,path:a.path,parent:{...a}});return D(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new E(a.common.issues)},input:a.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new E(a.common.issues)},input:a.data})}}removeCatch(){return this._def.innerType}}Ve.create=(e,t)=>new Ve({innerType:e,typeName:et.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...G(t)});class Ge extends J{_parse(e){if(this._getType(e)!==O.nan){const t=this._getOrReturnCtx(e);return A(t,{code:T.invalid_type,expected:O.nan,received:t.parsedType}),C}return{status:"valid",value:e.data}}}Ge.create=e=>new Ge({typeName:et.ZodNaN,...G(e)});const Je=Symbol("zod_brand");class Ke extends J{_parse(e){const{ctx:t}=this._processInputParams(e),a=t.data;return this._def.type._parse({data:a,path:t.path,parent:t})}unwrap(){return this._def.type}}class We extends J{_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:a.data,path:a.path,parent:a});return"aborted"===e.status?C:"dirty"===e.status?(t.dirty(),R(e.value)):this._def.out._parseAsync({data:e.value,path:a.path,parent:a})})();{const e=this._def.in._parseSync({data:a.data,path:a.path,parent:a});return"aborted"===e.status?C:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:a.path,parent:a})}}static create(e,t){return new We({in:e,out:t,typeName:et.ZodPipeline})}}class Qe extends J{_parse(e){const t=this._def.innerType._parse(e),a=e=>(Z(e)&&(e.value=Object.freeze(e.value)),e);return D(t)?t.then((e=>a(e))):a(t)}unwrap(){return this._def.innerType}}function Ye(e,t={},a){return e?ve.create().superRefine(((r,n)=>{var i,s;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(s=null!==(i=e.fatal)&&void 0!==i?i:a)||void 0===s||s,c="string"==typeof e?{message:e}:e;n.addIssue({code:"custom",...c,fatal:o})}})):ve.create()}Qe.create=(e,t)=>new Qe({innerType:e,typeName:et.ZodReadonly,...G(t)});const Xe={object:Te.lazycreate};var et;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(et||(et={}));const tt=ue.create,at=he.create,rt=Ge.create,nt=pe.create,it=me.create,st=fe.create,ot=ge.create,ct=ye.create,lt=be.create,ut=ve.create,dt=_e.create,ht=we.create,pt=ke.create,mt=Oe.create,ft=Te.create,gt=Te.strictCreate,yt=Ee.create,bt=Ie.create,vt=Se.create,_t=Ae.create,wt=Ne.create,kt=Ce.create,Ot=Re.create,xt=$e.create,Tt=Le.create,Et=Me.create,Pt=De.create,It=Ue.create,jt=Be.create,St=Fe.create,At=ze.create,Nt=He.create,Ct=Fe.createWithPreprocess,Rt=We.create,$t={string:e=>ue.create({...e,coerce:!0}),number:e=>he.create({...e,coerce:!0}),boolean:e=>me.create({...e,coerce:!0}),bigint:e=>pe.create({...e,coerce:!0}),date:e=>fe.create({...e,coerce:!0})},Lt=C;var Mt=Object.freeze({__proto__:null,defaultErrorMap:P,setErrorMap:function(e){I=e},getErrorMap:j,makeIssue:S,EMPTY_PATH:[],addIssueToContext:A,ParseStatus:N,INVALID:C,DIRTY:R,OK:$,isAborted:L,isDirty:M,isValid:Z,isAsync:D,get util(){return r},get objectUtil(){return n},ZodParsedType:O,getParsedType:x,ZodType:J,datetimeRegex:le,ZodString:ue,ZodNumber:he,ZodBigInt:pe,ZodBoolean:me,ZodDate:fe,ZodSymbol:ge,ZodUndefined:ye,ZodNull:be,ZodAny:ve,ZodUnknown:_e,ZodNever:we,ZodVoid:ke,ZodArray:Oe,ZodObject:Te,ZodUnion:Ee,ZodDiscriminatedUnion:Ie,ZodIntersection:Se,ZodTuple:Ae,ZodRecord:Ne,ZodMap:Ce,ZodSet:Re,ZodFunction:$e,ZodLazy:Le,ZodLiteral:Me,ZodEnum:De,ZodNativeEnum:Ue,ZodPromise:Be,ZodEffects:Fe,ZodTransformer:Fe,ZodOptional:ze,ZodNullable:He,ZodDefault:qe,ZodCatch:Ve,ZodNaN:Ge,BRAND:Je,ZodBranded:Ke,ZodPipeline:We,ZodReadonly:Qe,custom:Ye,Schema:J,ZodSchema:J,late:Xe,get ZodFirstPartyTypeKind(){return et},coerce:$t,any:ut,array:mt,bigint:nt,boolean:it,date:st,discriminatedUnion:bt,effect:St,enum:Pt,function:xt,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Ye((t=>t instanceof e),t),intersection:vt,lazy:Tt,literal:Et,map:kt,nan:rt,nativeEnum:It,never:ht,null:lt,nullable:Nt,number:at,object:ft,oboolean:()=>it().optional(),onumber:()=>at().optional(),optional:At,ostring:()=>tt().optional(),pipeline:Rt,preprocess:Ct,promise:jt,record:wt,set:Ot,strictObject:gt,string:tt,symbol:ot,transformer:St,tuple:_t,undefined:ct,union:yt,unknown:dt,void:pt,NEVER:Lt,ZodIssueCode:T,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:E}),Zt=a(116);const Dt={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let Ut;const Bt=new Uint8Array(16);function Ft(){if(!Ut&&(Ut="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ut))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ut(Bt)}const zt=[];for(let e=0;e<256;++e)zt.push((e+256).toString(16).slice(1));const Ht=function(e,t,a){if(Dt.randomUUID&&!t&&!e)return Dt.randomUUID();const r=(e=e||{}).random||(e.rng||Ft)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=r[e];return t}return function(e,t=0){return zt[e[t+0]]+zt[e[t+1]]+zt[e[t+2]]+zt[e[t+3]]+"-"+zt[e[t+4]]+zt[e[t+5]]+"-"+zt[e[t+6]]+zt[e[t+7]]+"-"+zt[e[t+8]]+zt[e[t+9]]+"-"+zt[e[t+10]]+zt[e[t+11]]+zt[e[t+12]]+zt[e[t+13]]+zt[e[t+14]]+zt[e[t+15]]}(r)};class qt{getStore(){}run(e,t){return t()}}const Vt=new class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new qt}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}};function Gt(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root");const Jt=()=>"undefined"!=typeof Deno;let Kt;async function Wt(){if(void 0===Kt){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Jt()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Jt()?"deno":"other":"node",e})();Kt={library:"langchain-js",runtime:e}}return Kt}function Qt(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}class Yt{}class Xt extends Yt{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,u(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==Qt("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return d.prototype.toJSON.call(this)}toJSONNotImplemented(){return d.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Xt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ht()}),Object.assign(this,e)}}}}var ea=a(418);function ta(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class aa extends Xt{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,a){const r=a.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),a={...e};if(void 0!==a.parent_run_id){const e=this.runMap.get(a.parent_run_id);e&&(this._addChildRun(e,a),e.child_execution_order=Math.max(e.child_execution_order,a.child_execution_order),a.trace_id=e.trace_id,void 0!==e.dotted_order&&(a.dotted_order=[e.dotted_order,t].join(".")))}else a.trace_id=a.id,a.dotted_order=t;this.runMap.set(a.id,a),await(this.onRunCreate?.(a))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,a,r,n,i,s,o){const c=this._getExecutionOrder(r),l=Date.now(),u=s?{...n,metadata:s}:n,d={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleChatModelStart(e,t,a,r,n,i,s,o){const c=this._getExecutionOrder(r),l=Date.now(),u=s?{...n,metadata:s}:n,d={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleLLMEnd(e,t){const a=this.runMap.get(t);if(!a||"llm"!==a?.run_type)throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await(this.onLLMEnd?.(a)),await this._endTrace(a),a}async handleLLMError(e,t){const a=this.runMap.get(t);if(!a||"llm"!==a?.run_type)throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await(this.onLLMError?.(a)),await this._endTrace(a),a}async handleChainStart(e,t,a,r,n,i,s,o){const c=this._getExecutionOrder(r),l=Date.now(),u={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(u),await(this.onChainStart?.(u)),u}async handleChainEnd(e,t,a,r,n){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=ta(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==n?.inputs&&(i.inputs=ta(n.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,a,r,n){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==n?.inputs&&(i.inputs=ta(n.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}async handleToolStart(e,t,a,r,n,i,s){const o=this._getExecutionOrder(r),c=Date.now(),l={id:a,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(l),await(this.onToolStart?.(l)),l}async handleToolEnd(e,t){const a=this.runMap.get(t);if(!a||"tool"!==a?.run_type)throw new Error("No tool run to end");return a.end_time=Date.now(),a.outputs={output:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await(this.onToolEnd?.(a)),await this._endTrace(a),a}async handleToolError(e,t){const a=this.runMap.get(t);if(!a||"tool"!==a?.run_type)throw new Error("No tool run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await(this.onToolError?.(a)),await this._endTrace(a),a}async handleAgentAction(e,t){const a=this.runMap.get(t);if(!a||"chain"!==a?.run_type)return;const r=a;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(a))}async handleAgentEnd(e,t){const a=this.runMap.get(t);a&&"chain"===a?.run_type&&(a.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(a)))}async handleRetrieverStart(e,t,a,r,n,i,s){const o=this._getExecutionOrder(r),c=Date.now(),l={id:a,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(l),await(this.onRetrieverStart?.(l)),l}async handleRetrieverEnd(e,t){const a=this.runMap.get(t);if(!a||"retriever"!==a?.run_type)throw new Error("No retriever run to end");return a.end_time=Date.now(),a.outputs={documents:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await(this.onRetrieverEnd?.(a)),await this._endTrace(a),a}async handleRetrieverError(e,t){const a=this.runMap.get(t);if(!a||"retriever"!==a?.run_type)throw new Error("No retriever run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await(this.onRetrieverError?.(a)),await this._endTrace(a),a}async handleText(e,t){const a=this.runMap.get(t);a&&"chain"===a?.run_type&&(a.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(a)))}async handleLLMNewToken(e,t,a,r,n,i){const s=this.runMap.get(a);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}function ra(e,t){return`${e.open}${t}${e.close}`}function na(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function ia(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:sa}=ea;class oa extends aa{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let a=e;for(;a.parent_run_id;){const e=this.runMap.get(a.parent_run_id);if(!e)break;t.push(e),a=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,a)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===a.length-1?ra(ea.bold,r):r})).join(" > ");return ra(sa.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.green,"[chain/start]")} [${t}] Entering Chain run with input: ${na(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.cyan,"[chain/end]")} [${t}] [${ia(e)}] Exiting Chain run with output: ${na(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.red,"[chain/error]")} [${t}] [${ia(e)}] Chain run errored with error: ${na(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),a="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${ra(sa.green,"[llm/start]")} [${t}] Entering LLM run with input: ${na(a,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.cyan,"[llm/end]")} [${t}] [${ia(e)}] Exiting LLM run with output: ${na(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.red,"[llm/error]")} [${t}] [${ia(e)}] LLM run errored with error: ${na(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.cyan,"[tool/end]")} [${t}] [${ia(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.red,"[tool/error]")} [${t}] [${ia(e)}] Tool run errored with error: ${na(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${na(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.cyan,"[retriever/end]")} [${t}] [${ia(e)}] Exiting Retriever run with output: ${na(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${ra(sa.red,"[retriever/error]")} [${t}] [${ia(e)}] Retriever run errored with error: ${na(e.error,"[error]")}`)}onAgentAction(e){const t=e,a=this.getBreadcrumbs(e);console.log(`${ra(sa.blue,"[agent/action]")} [${a}] Agent selected action: ${na(t.actions[t.actions.length-1],"[action]")}`)}}const ca={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let la;const ua=new Uint8Array(16);function da(){if(!la&&(la="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!la))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return la(ua)}const ha=[];for(let e=0;e<256;++e)ha.push((e+256).toString(16).slice(1));const pa=function(e,t,a){if(ca.randomUUID&&!t&&!e)return ca.randomUUID();const r=(e=e||{}).random||(e.rng||da)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=r[e];return t}return function(e,t=0){return ha[e[t+0]]+ha[e[t+1]]+ha[e[t+2]]+ha[e[t+3]]+"-"+ha[e[t+4]]+ha[e[t+5]]+"-"+ha[e[t+6]]+ha[e[t+7]]+"-"+ha[e[t+8]]+ha[e[t+9]]+"-"+ha[e[t+10]]+ha[e[t+11]]+ha[e[t+12]]+ha[e[t+13]]+ha[e[t+14]]+ha[e[t+15]]}(r)};var ma=a(290);const fa=[400,401,403,404,405,406,407,408],ga=[409];class ya{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new ma.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const a=this.onFailedResponseHook;return this.queue.add((()=>Zt((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(fa.includes(+r))throw e;if(ga.includes(+r))return;a&&await a(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise(((t,a)=>{e.signal?.addEventListener("abort",(()=>{a(new Error("AbortError"))}))}))]):this.call(t,...a)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function ba(e){return"function"==typeof e?._getType}function va(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}let _a;const wa=()=>"undefined"!=typeof Deno,ka=()=>_a||(_a="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||wa()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":wa()?"deno":"other":"node",_a);let Oa,xa;function Ta(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}const Ea=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Pa(e){if("string"!=typeof(t=e)||!Ea.test(t))throw new Error(`Invalid UUID: ${e}`);var t}const Ia={};async function ja(e){const t=await async function(){if(void 0===Oa){const e=ka(),t=function(){if(void 0!==xa)return xa;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const a of e){const e=Ta(a);void 0!==e&&(t[a]=e)}return xa=t,t}();Oa={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:$a,...t}}return Oa}(),a=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,a])=>(e[t]=String(a),e)),{}):void 0}catch(e){return}}()||{},t={},a=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,n]of Object.entries(e))!r.startsWith("LANGCHAIN_")||"string"!=typeof n||a.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=n:t[r]=n);return t}();return e.map((e=>{const r=e.extra??{},n=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...a,...a.revision_id||e.revision_id?{revision_id:e.revision_id??a.revision_id}:{},...n}},e}))}const Sa=async(e,t)=>{const a=await e.text();if(!e.ok)throw new Error(`Failed to ${t}: ${e.status} ${e.statusText} ${a}`)};function Aa(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Na=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class Ca{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise((t=>{this.items.push([e,t])}))}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const e=this.items.shift();if(!e)break;t.push(e)}return[t.map((e=>e[0])),()=>t.forEach((e=>e[1]()))]}}class Ra{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ca}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=Ra.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=Ta("LANGCHAIN_TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=Aa(e.apiUrl??t.apiUrl)??"",this.apiKey=Aa(e.apiKey??t.apiKey),this.webUrl=Aa(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new ya(e.callerOptions??{}),this.batchIngestCaller=new ya({...e.callerOptions??{},onFailedResponseHook:Na}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=Ta("LANGCHAIN_API_KEY");return{apiUrl:Ta("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===Ta("LANGCHAIN_HIDE_INPUTS"),hideOutputs:"true"===Ta("LANGCHAIN_HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${$a}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const a=t?.toString()??"",r=`${this.apiUrl}${e}?${a}`,n=await this.caller.call(fetch,r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to fetch ${e}: ${n.status} ${n.statusText}`);return n}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let a=Number(t.get("offset"))||0;const r=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(r));const n=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const s=await i.json();if(0===s.length)break;if(yield s,s.length<r)break;a+=s.length}}async*_getCursorPaginatedList(e,t=null,a="POST",r="runs"){const n=t?{...t}:{};for(;;){const t=await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:a,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(n)}),i=await t.json();if(!i)break;if(!i[r])break;yield i[r];const s=i.cursors;if(!s)break;if(!s.next)break;n.cursor=s.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const a of e)this.sampledPostUuids.has(a.id)&&(t.push(a),this.sampledPostUuids.delete(a.id));return t}{const t=[];for(const a of e)Math.random()<this.tracingSampleRate&&(t.push(a),this.sampledPostUuids.add(a.id));return t}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length)return void t();try{await this.batchIngestRuns({runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))})}finally{t()}}}async processRunOperation(e,t){const a=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const r=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),a?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},a=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:a,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const n=await ja([r]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(n[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let a=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(a.length>0&&r.length>0){const e=a.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const a of r)void 0!==a.id&&e[a.id]?e[a.id]={...e[a.id],...a}:t.push(a);a=Object.values(e),r=t}const n={post:this._filterForSampling(a),patch:this._filterForSampling(r,!0)};if(!n.post.length&&!n.patch.length)return;if(a=await ja(a),void 0===this.batchEndpointSupported&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const e of n.post)await this.createRun(e);for(const e of n.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??20971520,s={post:[],patch:[]};let o=0;for(const e of["post","patch"]){const t=e,a=n[t].reverse();let r=a.pop();for(;void 0!==r;){const e=JSON.stringify(r);o>0&&o+e.length>i&&(await this._postBatchIngestRuns(JSON.stringify(s)),o=0,s.post=[],s.patch=[]),o+=e.length,s[t].push(r),r=a.pop()}}(s.post.length>0||s.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(s))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},a=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(a,"batch create run")}async updateRun(e,t){Pa(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const a={...t,id:e};if(!this._filterForSampling([a],!0).length)return;if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order)return void 0!==t.end_time&&void 0===a.parent_run_id?void await this.processRunOperation({action:"update",item:a},!0):void this.processRunOperation({action:"update",item:a}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},n=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(n,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Pa(e);let a=await this._get(`/runs/${e}`);return t&&a.child_run_ids&&(a=await this._loadChildRuns(a)),a}async getRunUrl({runId:e,run:t,projectOpts:a}){if(void 0!==t){let e;e=t.session_id?t.session_id:a?.projectName?(await this.readProject({projectName:a?.projectName})).id:a?.projectId?a?.projectId:(await this.readProject({projectName:Ta("LANGCHAIN_PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const a of e)t.push(a);return t}(this.listRuns({id:e.child_run_ids})),a={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in a||(a[e.parent_run_id]=[]),a[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=a[e.id]||[];for(const t in a)t!==e.id&&(r[t].child_runs=a[t]);return e}async*listRuns(e){const{projectId:t,projectName:a,parentRunId:r,traceId:n,referenceExampleId:i,startTime:s,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:h,filter:p,traceFilter:m,treeFilter:f,limit:g,select:y}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),a){const e=Array.isArray(a)?a:[a],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));b.push(...t)}const v={session:b.length?b:null,run_type:l,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:f,execution_order:o,parent_run:r,start_time:s?s.toISOString():null,error:u,id:d,limit:g,trace:n,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let _=0;for await(const e of this._getCursorPaginatedList("/runs/query",v))if(g){if(_>=g)break;if(e.length+_>g){const t=e.slice(0,g-_);yield*t;break}_+=e.length,yield*e}else yield*e}async shareRun(e,{shareId:t}={}){const a={run_id:e,share_token:t||pa()};Pa(e);const r=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await r.json();if(null===n||!("share_token"in n))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${n.share_token}/r`}async unshareRun(e){Pa(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(t,"unshare run")}async readRunSharedLink(e){Pa(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await t.json();if(null!==a&&"share_token"in a)return`${this.getHostUrl()}/public/${a.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const a=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)a.append("id",e);Pa(e);const r=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Pa(e);const a=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await a.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const a={dataset_id:e};Pa(e);const r=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await r.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(e){Pa(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(t,"unshare dataset")}async readSharedDataset(e){Pa(e);const t=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async createProject({projectName:e,description:t=null,metadata:a=null,upsert:r=!1,projectExtra:n=null,referenceDatasetId:i=null}){const s=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${s}`,c=n||{};a&&(c.metadata=a);const l={name:e,extra:c,description:t};null!==i&&(l.reference_dataset_id=i);const u=await this.caller.call(fetch,o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await u.json();if(!u.ok)throw new Error(`Failed to create session ${e}: ${u.status} ${u.statusText}`);return d}async updateProject(e,{name:t=null,description:a=null,metadata:r=null,projectExtra:n=null,endTime:i=null}){const s=`${this.apiUrl}/sessions/${e}`;let o=n;r&&(o={...o||{},metadata:r});const c={name:t,extra:o,description:a,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(fetch,s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),u=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return u}async hasProject({projectId:e,projectName:t}){let a="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Pa(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const n=await this.caller.call(fetch,`${this.apiUrl}${a}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await n.json();return!!n.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:a}){let r="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Pa(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}void 0!==a&&n.append("include_stats",a.toString());const i=await this._get(r,n);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const a=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${a.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const a=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${a.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:a,referenceDatasetId:r,referenceDatasetName:n,referenceFree:i}={}){const s=new URLSearchParams;if(void 0!==e)for(const t of e)s.append("id",t);if(void 0!==t&&s.append("name",t),void 0!==a&&s.append("name_contains",a),void 0!==r)s.append("reference_dataset",r);else if(void 0!==n){const e=await this.readDataset({datasetName:n});s.append("reference_dataset",e.id)}void 0!==i&&s.append("reference_free",i.toString());for await(const e of this._getPaginated("/sessions",s))yield*e}async deleteProject({projectId:e,projectName:t}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");a=void 0===e?(await this.readProject({projectName:t})).id:e,Pa(a);const r=await this.caller.call(fetch,`${this.apiUrl}/sessions/${a}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(r,`delete session ${a} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:a,outputKeys:r,description:n,dataType:i,name:s}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),a.forEach((e=>{c.append("input_keys",e)})),r.forEach((e=>{c.append("output_keys",e)})),n&&c.append("description",n),i&&c.append("data_type",i),s&&c.append("name",s);const l=await this.caller.call(fetch,o,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok){const e=await l.json();if(e.detail&&e.detail.includes("already exists"))throw new Error(`Dataset ${t} already exists`);throw new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:a}={}){const r={name:e,description:t};a&&(r.data_type=a);const n=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok){const t=await n.json();if(t.detail&&t.detail.includes("already exists"))throw new Error(`Dataset ${e} already exists`);throw new Error(`Failed to create dataset ${n.status} ${n.statusText}`)}return await n.json()}async readDataset({datasetId:e,datasetName:t}){let a="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)Pa(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const n=await this._get(a,r);let i;if(Array.isArray(n)){if(0===n.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=n[0]}else i=n;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:a,toVersion:r}){let n=e;if(void 0===n&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===n&&(n=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:"string"==typeof a?a:a.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${n}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const a=await this._getResponse(`/datasets/${e}/openai_ft`);return(await a.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:a,datasetName:r,datasetNameContains:n}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==a)for(const e of a)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==n&&i.append("name_contains",n);for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:a,...r}=e;if(!t&&!a)throw new Error("Must provide either datasetName or datasetId");const n=t??(await this.readDataset({datasetName:a})).id;Pa(n);const i=await this.caller.call(fetch,`${this.apiUrl}/datasets/${n}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to update dataset ${n}: ${i.status} ${i.statusText}`);return await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let a="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");Pa(r),a+=`/${r}`;const n=await this.caller.call(fetch,this.apiUrl+a,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${a}: ${n.status} ${n.statusText}`);await n.json()}async createExample(e,t,{datasetId:a,datasetName:r,createdAt:n,exampleId:i,metadata:s,split:o}){let c=a;if(void 0===c&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===c&&(c=(await this.readDataset({datasetName:r})).id);const l=n||new Date,u={dataset_id:c,inputs:e,outputs:t,created_at:l?.toISOString(),id:i,metadata:s,split:o},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){const{inputs:t,outputs:a,metadata:r,sourceRunIds:n,exampleIds:i,datasetId:s,datasetName:o}=e;let c=s;if(void 0===c&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:o});c=e.id}const l=t.map(((t,s)=>({dataset_id:c,inputs:t,outputs:a?a[s]:void 0,metadata:r?r[s]:void 0,split:e.splits?e.splits[s]:void 0,id:i?i[s]:void 0,source_run_id:n?n[s]:void 0}))),u=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!u.ok)throw new Error(`Failed to create examples: ${u.status} ${u.statusText}`);return await u.json()}async createLLMExample(e,t,a){return this.createExample({input:e},{output:t},a)}async createChatExample(e,t,a){const r=e.map((e=>ba(e)?va(e):e)),n=ba(t)?va(t):t;return this.createExample({input:r},{output:n},a)}async readExample(e){Pa(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:a,asOf:r,splits:n,inlineS3Urls:i,metadata:s,limit:o,offset:c,filter:l}={}){let u;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");u=(await this.readDataset({datasetName:t})).id}const d=new URLSearchParams({dataset:u}),h=r?"string"==typeof r?r:r?.toISOString():void 0;h&&d.append("as_of",h);const p=i??!0;if(d.append("inline_s3_urls",p.toString()),void 0!==a)for(const e of a)d.append("id",e);if(void 0!==n)for(const e of n)d.append("splits",e);if(void 0!==s){const e=JSON.stringify(s);d.append("metadata",e)}void 0!==o&&d.append("limit",o.toString()),void 0!==c&&d.append("offset",c.toString()),void 0!==l&&d.append("filter",l);let m=0;for await(const e of this._getPaginated("/examples",d)){for(const t of e)yield t,m++;if(void 0!==o&&m>=o)break}}async deleteExample(e){Pa(e);const t=`/examples/${e}`,a=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to delete ${t}: ${a.status} ${a.statusText}`);await a.json()}async updateExample(e,t){Pa(e);const a=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to update example ${e}: ${a.status} ${a.statusText}`);return await a.json()}async evaluateRun(e,t,{sourceInfo:a,loadChildRuns:r,referenceExample:n}={loadChildRuns:!1}){var i;let s;if(Ia[i="This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."]||(console.warn(i),Ia[i]=!0),"string"==typeof e)s=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(n=await this.readExample(s.reference_example_id));const o=await t.evaluateRun(s,n),[c,l]=await this._logEvaluationFeedback(o,s,a);return l[0]}async createFeedback(e,t,{score:a,value:r,correction:n,comment:i,sourceInfo:s,feedbackSourceType:o="api",sourceRunId:c,feedbackId:l,feedbackConfig:u,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const p={type:o??"api",metadata:s??{}};void 0===c||void 0===p?.metadata||p.metadata.__run||(p.metadata.__run={run_id:c}),void 0!==p?.metadata&&void 0!==p.metadata.__run?.run_id&&Pa(p.metadata.__run.run_id);const m={id:l??pa(),run_id:e,key:t,score:a,value:r,correction:n,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:u,session_id:d},f=`${this.apiUrl}/feedback`,g=await this.caller.call(fetch,f,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Sa(g,"create feedback"),m}async updateFeedback(e,{score:t,value:a,correction:r,comment:n}){const i={};null!=t&&(i.score=t),null!=a&&(i.value=a),null!=r&&(i.correction=r),null!=n&&(i.comment=n),Pa(e);const s=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Sa(s,"update feedback")}async readFeedback(e){Pa(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Pa(e);const t=`/feedback/${e}`,a=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to delete ${t}: ${a.status} ${a.statusText}`);await a.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:a}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(a)for(const e of a)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:a,feedbackConfig:r}={}){const n={run_id:e,feedback_key:t,feedback_config:r};a?"string"==typeof a?n.expires_at=a:(a?.hours||a?.minutes||a?.days)&&(n.expires_in=a):n.expires_in={hours:3};const i=await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:a,createdAt:r,description:n,metadata:i,id:s}){if(0===t.length)throw new Error("At least one experiment is required");if(a||(a=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!a)throw new Error("A reference dataset is required");const o={id:s,name:e,experiment_ids:t,reference_dataset_id:a,description:n,created_at:(r??new Date)?.toISOString(),extra:{}};i&&(o.extra.metadata=i);const c=await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){Pa(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,a){const r=this._selectEvalResults(e),n=[];for(const e of r){let r=a||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),n.push(await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,n]}async logEvaluationFeedback(e,t,a){const[r]=await this._logEvaluationFeedback(e,t,a);return r}}const $a="0.1.35";class La extends aa{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:a,client:r}=e;this.projectName=a??Qt("LANGCHAIN_PROJECT")??Qt("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??new Ra({});const n=this.getTraceableRunTree();if(n){let e=n;const t=new Set;for(;e.parent_run&&!t.has(e.id)&&(t.add(e.id),e.parent_run);)e=e.parent_run;t.clear();const a=[e];for(;a.length>0;){const e=a.shift();e&&!t.has(e.id)&&(t.add(e.id),this.runMap.set(e.id,e),e.child_runs&&a.push(...e.child_runs))}this.client=n.client??this.client,this.projectName=n.project_name??this.projectName,this.exampleId=n.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Wt()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return(()=>{const e=Vt.getInstance().getStore();if(void 0===e)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));return e})()}catch{return}}}let Ma;async function Za(e,t){!0===t?await e():(void 0===Ma&&(Ma=new(0,ma.default)({autoStart:!0,concurrency:1})),Ma.add(e))}"true"===Qt("LANGCHAIN_TRACING_V2")&&"true"!==Qt("LANGCHAIN_CALLBACKS_BACKGROUND")&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join("\n");class Da{setHandler(e){return this.setHandlers([e])}}class Ua{constructor(e,t,a,r,n,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map((t=>Za((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Ba extends Ua{getChild(e){const t=new qa(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(a){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Fa extends Ua{async handleLLMNewToken(e,t,a,r,n,i){await Promise.all(this.handlers.map((a=>Za((async()=>{if(!a.ignoreLLM)try{await(a.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){if(console.error(`Error in handler ${a.constructor.name}, handleLLMNewToken: ${e}`),a.raiseError)throw e}}),a.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class za extends Ua{getChild(e){const t=new qa(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,a,r,n){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,a,r,n){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Ha extends Ua{getChild(e){const t=new qa(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>Za((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class qa extends Da{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,a=void 0,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const i=0===r&&a?a:Ht();return await Promise.all(this.handlers.map((a=>Za((async()=>{if(!a.ignoreLLM)try{await(a.handleLLMStart?.(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o))}catch(e){if(console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)))),new Fa(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,a=void 0,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const i=0===r&&a?a:Ht();return await Promise.all(this.handlers.map((a=>Za((async()=>{if(!a.ignoreLLM)try{if(a.handleChatModelStart)await(a.handleChatModelStart?.(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o));else if(a.handleLLMStart){const r=k(t);await(a.handleLLMStart?.(e,[r],i,this._parentRunId,n,this.tags,this.metadata,o))}}catch(e){if(console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)))),new Fa(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,a=Ht(),r=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((n=>Za((async()=>{if(!n.ignoreChain)try{await(n.handleChainStart?.(e,t,a,this._parentRunId,this.tags,this.metadata,r,s))}catch(e){if(console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)))),new za(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,a=Ht(),r=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((r=>Za((async()=>{if(!r.ignoreAgent)try{await(r.handleToolStart?.(e,t,a,this._parentRunId,this.tags,this.metadata,s))}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)))),new Ha(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,a=Ht(),r=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((r=>Za((async()=>{if(!r.ignoreRetriever)try{await(r.handleRetrieverStart?.(e,t,a,this._parentRunId,this.tags,this.metadata,s))}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)))),new Ba(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const a of e)this.addHandler(a,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const a=new qa(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);a.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);a.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);a.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)a.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||a.addHandler(r,t);return a}static fromHandlers(e){const t=new this;return t.addHandler(new class extends Xt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ht()}),Object.assign(this,e)}}),t}static async configure(e,t,a,r,n,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new qa,o.setHandlers(e?.map(Va)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Va):t?.handlers,!1));const c="true"===Qt("LANGCHAIN_VERBOSE")||s?.verbose,l="true"===Qt("LANGCHAIN_TRACING_V2")||"true"===Qt("LANGSMITH_TRACING"),u=l||(Qt("LANGCHAIN_TRACING")??!1);if(c||u){if(o||(o=new qa),c&&!o.handlers.some((e=>e.name===oa.prototype.name))){const e=new oa;o.addHandler(e,!0)}if(u&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&l){const e=await async function(){return new La}();o.addHandler(e,!0),o._parentRunId=e.getTraceableRunTree()?.id??o._parentRunId}}return(a||r)&&o&&(o.addTags(a??[]),o.addTags(r??[],!1)),(n||i)&&o&&(o.addMetadata(n??{}),o.addMetadata(i??{},!1)),o}}function Va(e){return"name"in e?e:Xt.fromMethods(e)}const Ga=Object.prototype.hasOwnProperty;function Ja(e,t){return Ga.call(e,t)}function Ka(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Wa(e){let t=0;const a=e.length;let r;for(;t<a;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function Qa(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,a=e.length;t<a;t++)if(Qa(e[t]))return!0}else if("object"==typeof e){const a=function(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let a in e)Ja(e,a)&&t.push(a);return t}(e),r=a.length;for(var t=0;t<r;t++)if(Qa(e[a[t]]))return!0}return!1}function Ya(e,t){const a=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&a.push(`${e}: ${r}`)}return a.join("\n")}class Xa extends Error{constructor(e,t,a,r,n){super(Ya(e,{name:t,index:a,operation:r,tree:n})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.setPrototypeOf(this,new.target.prototype),this.message=Ya(e,{name:t,index:a,operation:r,tree:n})}}const er=Xa,tr=Ka,ar={add:function(e,t,a){return e[t]=this.value,{newDocument:a}},remove:function(e,t,a){var r=e[t];return delete e[t],{newDocument:a,removed:r}},replace:function(e,t,a){var r=e[t];return e[t]=this.value,{newDocument:a,removed:r}},move:function(e,t,a){let r=nr(a,this.path);r&&(r=Ka(r));const n=ir(a,{op:"remove",path:this.from}).removed;return ir(a,{op:"add",path:this.path,value:n}),{newDocument:a,removed:r}},copy:function(e,t,a){const r=nr(a,this.from);return ir(a,{op:"add",path:this.path,value:Ka(r)}),{newDocument:a}},test:function(e,t,a){return{newDocument:a,test:ur(e[t],this.value)}},_get:function(e,t,a){return this.value=e[t],{newDocument:a}}};var rr={add:function(e,t,a){return Wa(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:a,index:t}},remove:function(e,t,a){return{newDocument:a,removed:e.splice(t,1)[0]}},replace:function(e,t,a){var r=e[t];return e[t]=this.value,{newDocument:a,removed:r}},move:ar.move,copy:ar.copy,test:ar.test,_get:ar._get};function nr(e,t){if(""==t)return e;var a={op:"_get",path:t};return ir(e,a),a.value}function ir(e,t,a=!1,r=!0,n=!0,i=0){if(a&&("function"==typeof a?a(t,0,e,t.path):cr(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=nr(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=ur(e,t.value),!1===r.test)throw new er("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(a)throw new er("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return r}{r||(e=Ka(e));const s=(t.path||"").split("/");let o,c,l,u=e,d=1,h=s.length;for(l="function"==typeof a?a:cr;;){if(c=s[d],c&&-1!=c.indexOf("~")&&(c=c.replace(/~1/g,"/").replace(/~0/g,"~")),n&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==s[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(a&&void 0===o&&(void 0===u[c]?o=s.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&l(t,0,e,o)),d++,Array.isArray(u)){if("-"===c)c=u.length;else{if(a&&!Wa(c))throw new er("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Wa(c)&&(c=~~c)}if(d>=h){if(a&&"add"===t.op&&c>u.length)throw new er("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const r=rr[t.op].call(t,u,c,e);if(!1===r.test)throw new er("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}}else if(d>=h){const a=ar[t.op].call(t,u,c,e);if(!1===a.test)throw new er("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a}if(u=u[c],a&&d<h&&(!u||"object"!=typeof u))throw new er("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function sr(e,t,a,r=!0,n=!0){if(a&&!Array.isArray(t))throw new er("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=Ka(e));const i=new Array(t.length);for(let r=0,s=t.length;r<s;r++)i[r]=ir(e,t[r],a,!0,n,r),e=i[r].newDocument;return i.newDocument=e,i}function or(e,t,a){const r=ir(e,t);if(!1===r.test)throw new er("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r.newDocument}function cr(e,t,a,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new er("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,a);if(!ar[e.op])throw new er("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,a);if("string"!=typeof e.path)throw new er("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,a);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new er('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,a);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new er("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,a);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new er("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,a);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&Qa(e.value))throw new er("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,a);if(a)if("add"==e.op){var n=e.path.split("/").length,i=r.split("/").length;if(n!==i+1&&n!==i)throw new er("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,a)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new er("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,a)}else if("move"===e.op||"copy"===e.op){var s=lr([{op:"_get",path:e.from,value:void 0}],a);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new er("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,a)}}function lr(e,t,a){try{if(!Array.isArray(e))throw new er("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)sr(Ka(t),Ka(e),a||!0);else{a=a||cr;for(var r=0;r<e.length;r++)a(e[r],r,t,void 0)}}catch(e){if(e instanceof er)return e;throw e}}function ur(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var a,r,n,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((r=e.length)!=t.length)return!1;for(a=r;0!=a--;)if(!ur(e[a],t[a]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(a=r;0!=a--;)if(!t.hasOwnProperty(o[a]))return!1;for(a=r;0!=a--;)if(!ur(e[n=o[a]],t[n]))return!1;return!0}return e!=e&&t!=t}new WeakMap;const dr=new class{getStore(){}run(e,t){return t()}},hr=new class{getInstance(){return globalThis.__lc_tracing_async_local_storage??dr}initializeGlobalInstance(e){void 0===globalThis.__lc_tracing_async_local_storage&&(globalThis.__lc_tracing_async_local_storage=e)}};class pr extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new pr({start:e=>function a(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),a();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new pr({async pull(t){const{value:a,done:r}=await e.next();r&&t.close(),t.enqueue(a)},async cancel(t){await e.return(t)}})}}function mr(e,t=2){const a=Array.from({length:t},(()=>[]));return a.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of a)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function fr(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const a={...e};for(const[e,r]of Object.entries(t))e in a&&!Array.isArray(a[e])?a[e]=fr(a[e],r):a[e]=r;return a}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class gr{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise(((t,a)=>{hr.getInstance().run(e.config,(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,a):this.firstResult.then((e=>t(void 0)),a)}))}))}async next(...e){return this.firstResultUsed?hr.getInstance().run(this.config,(async()=>this.generator.next(...e))):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class yr{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),a=sr({},t);return new br({ops:t,state:a[a.length-1].newDocument})}}class br extends yr{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),a=sr(this.state,e.ops);return new br({ops:t,state:a[a.length-1].newDocument})}static fromRunLogPatch(e){const t=sr({},e.ops);return new br({ops:e.ops,state:t[t.length-1].newDocument})}}const vr=e=>"log_stream_tracer"===e.name;async function _r(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:a}=e;return["retriever","llm","prompt"].includes(e.run_type)?a:1!==Object.keys(a).length||""!==a?.input?a.input:void 0}async function wr(e,t){const{outputs:a}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?a:void 0!==a&&1===Object.keys(a).length&&void 0!==a?.output?a.output:a}class kr extends aa{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=pr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let a=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(a=a||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(a=a||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(a=a||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(a=a&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(a=a&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(a=a&&t.every((e=>!this.excludeTags?.includes(e)))),a}async*tapOutputIterable(e,t){for await(const a of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new yr({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:a}]}))}yield a}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new yr({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const a={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(a.inputs=await _r(e,this._schemaFormat)),await this.writer.write(new yr({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:a}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const a=[];"streaming_events"===this._schemaFormat&&a.push({op:"replace",path:`/logs/${t}/inputs`,value:await _r(e,this._schemaFormat)}),a.push({op:"add",path:`/logs/${t}/final_output`,value:await wr(e,this._schemaFormat)}),void 0!==e.end_time&&a.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new yr({ops:a});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new yr({ops:[{op:"replace",path:"/final_output",value:await wr(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,a){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let n;var i;void 0!==e.inputs.messages?(i=a?.chunk,n=void 0!==i&&void 0!==i.message?a?.chunk:new y(t)):n=t;const s=new yr({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:n}]});await this.writer.write(s)}}const Or="__run";class xr{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new xr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function Tr({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const Er=e=>"event_stream_tracer"===e.name;class Pr extends aa{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=pr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let a=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(a=a||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(a=a||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(a=a||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(a=a&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(a=a&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(a=a&&t.every((e=>!this.excludeTags?.includes(e)))),a}async*tapOutputIterable(e,t){const a=await t.next();if(a.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield a.value);let n=this.tappedPromises.get(e);if(void 0===n){let i;n=new Promise((e=>{i=e})),this.tappedPromises.set(e,n);try{const n={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...n,data:{chunk:a.value}},r),yield a.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...n,data:{chunk:e}},r),yield e}finally{i()}}else{yield a.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const a=this.tappedPromises.get(e.run_id);void 0!==a?a.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=Tr(e),a=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:a,inputs:e.inputs};this.runInfoMap.set(e.id,r);const n=`on_${a}_start`;await this.send({event:n,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,a){const r=this.runInfoMap.get(e.id);let n,i;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if("chat_model"===r.runType)i="on_chat_model_stream",n=void 0===a?.chunk?new y({content:t}):a.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);i="on_llm_stream",n=void 0===a?.chunk?new xr({text:t}):a.chunk}await this.send({event:i,data:{chunk:n},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let a;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let n;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==n)break;n=e[0]?.message}a="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);n={generations:r?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},a="on_llm_end"}await this.sendEndEvent({event:a,data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Tr(e),a=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let n={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(n={},r.inputs={}):void 0!==e.inputs.input?(n.input=e.inputs.input,r.inputs=e.inputs.input):(n.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${a}_start`,data:n,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const a=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},n={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(n.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:a,data:n,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Tr(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,a),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},a)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const a=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Tr(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}async function Ir(e){return qa.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function jr(...e){const t={};for(const a of e.filter((e=>!!e)))for(const e of Object.keys(a))if("metadata"===e)t[e]={...t[e],...a[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(a[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...a[e]};else if("callbacks"===e){const e=t.callbacks,r=a.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const a=e.copy();for(const e of r)a.addHandler(Va(e),!0);t.callbacks=a}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const a=r.copy();for(const t of e)a.addHandler(Va(t),!0);t.callbacks=a}else t.callbacks=new qa(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=a[r]??t[r]}return t}const Sr=new Set(["string","number","boolean"]);function Ar(e){const t=e??hr.getInstance().getStore();let a={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(t&&(a={...a,...t}),t?.configurable)for(const e of Object.keys(t.configurable))Sr.has(typeof t.configurable[e])&&!a.metadata?.[e]&&(a.metadata||(a.metadata={}),a.metadata[e]=t.configurable[e]);return a}function Nr(e={},{callbacks:t,maxConcurrency:a,recursionLimit:r,runName:n,configurable:i,runId:s}={}){const o=Ar(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==a&&(o.maxConcurrency=a),void 0!==n&&(o.runName=n),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==s&&delete o.runId,o}const Cr=[400,401,402,403,404,405,406,407,409],Rr=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&Cr.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class $r{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Rr;const t=ma.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>Zt((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise(((t,a)=>{e.signal?.addEventListener("abort",(()=>{a(new Error("AbortError"))}))}))]):this.call(t,...a)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}class Lr extends aa{constructor({config:e,onStart:t,onEnd:a,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=a,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function Mr(e){return!!e&&e.lc_runnable}class Zr{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let a=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(a=a||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(a=a||this.includeTypes.includes(t)),void 0!==this.includeTags&&(a=a||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(a=a&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(a=a&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(a=a&&r.every((e=>!this.excludeTags?.includes(e)))),a}}const Dr=Symbol("Let zodToJsonSchema decide on which parser to use"),Ur={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function Br(e,t,a,r){r?.errorMessages&&a&&(e.errorMessage={...e.errorMessage,[t]:a})}function Fr(e,t,a,r,n){e[t]=a,Br(e,t,r,n)}function zr(e,t,a){const r=a??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((a,r)=>zr(e,t,a)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Hr(e,t)}}const Hr=(e,t)=>{const a={type:"integer",format:"unix-time"};if("openApi3"===t.target)return a;for(const r of e.checks)switch(r.kind){case"min":Fr(a,"minimum",r.value,r.message,t);break;case"max":Fr(a,"maximum",r.value,r.message,t)}return a},qr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u"),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Vr(e,t){const a={type:"string"};function r(e){return"escape"===t.patternStrategy?Gr(e):e}if(e.checks)for(const n of e.checks)switch(n.kind){case"min":Fr(a,"minLength","number"==typeof a.minLength?Math.max(a.minLength,n.value):n.value,n.message,t);break;case"max":Fr(a,"maxLength","number"==typeof a.maxLength?Math.min(a.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Jr(a,"email",n.message,t);break;case"format:idn-email":Jr(a,"idn-email",n.message,t);break;case"pattern:zod":Kr(a,qr.email,n.message,t)}break;case"url":Jr(a,"uri",n.message,t);break;case"uuid":Jr(a,"uuid",n.message,t);break;case"regex":Kr(a,n.regex,n.message,t);break;case"cuid":Kr(a,qr.cuid,n.message,t);break;case"cuid2":Kr(a,qr.cuid2,n.message,t);break;case"startsWith":Kr(a,RegExp(`^${r(n.value)}`),n.message,t);break;case"endsWith":Kr(a,RegExp(`${r(n.value)}$`),n.message,t);break;case"datetime":Jr(a,"date-time",n.message,t);break;case"date":Jr(a,"date",n.message,t);break;case"time":Jr(a,"time",n.message,t);break;case"duration":Jr(a,"duration",n.message,t);break;case"length":Fr(a,"minLength","number"==typeof a.minLength?Math.max(a.minLength,n.value):n.value,n.message,t),Fr(a,"maxLength","number"==typeof a.maxLength?Math.min(a.maxLength,n.value):n.value,n.message,t);break;case"includes":Kr(a,RegExp(r(n.value)),n.message,t);break;case"ip":"v6"!==n.version&&Jr(a,"ipv4",n.message,t),"v4"!==n.version&&Jr(a,"ipv6",n.message,t);break;case"emoji":Kr(a,qr.emoji,n.message,t);break;case"ulid":Kr(a,qr.ulid,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Jr(a,"binary",n.message,t);break;case"contentEncoding:base64":Fr(a,"contentEncoding","base64",n.message,t);break;case"pattern:zod":Kr(a,qr.base64,n.message,t)}break;case"nanoid":Kr(a,qr.nanoid,n.message,t)}return a}const Gr=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),Jr=(e,t,a,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...a&&r.errorMessages&&{errorMessage:{format:a}}})):Fr(e,"format",t,a,r)},Kr=(e,t,a,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:Wr(t,r),...a&&r.errorMessages&&{errorMessage:{pattern:a}}})):Fr(e,"pattern",Wr(t,r),a,r)},Wr=(e,t)=>{if(!t.applyRegexFlags||!e.flags)return e.source;const a=e.flags.includes("i"),r=e.flags.includes("m"),n=e.flags.includes("s"),i=a?e.source.toLowerCase():e.source;let s="",o=!1,c=!1,l=!1;for(let e=0;e<i.length;e++)if(o)s+=i[e],o=!1;else{if(a)if(c){if(i[e].match(/[a-z]/)){l?(s+=i[e],s+=`${i[e-2]}-${i[e]}`.toUpperCase(),l=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(s+=i[e],l=!0):s+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){s+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(r){if("^"===i[e]){s+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){s+="($|(?=[\r\n]))";continue}}n&&"."===i[e]?s+=c?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(s+=i[e],"\\"===i[e]?o=!0:c&&"]"===i[e]?c=!1:c||"["!==i[e]||(c=!0))}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return s};function Qr(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===et.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((a,r)=>({...a,[r]:tn(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const a={type:"object",additionalProperties:tn(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return a;if(e.keyType?._def.typeName===et.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(Vr(e.keyType._def,t)).reduce(((e,[t,a])=>"type"===t?e:{...e,[t]:a}),{});return{...a,propertyNames:r}}return e.keyType?._def.typeName===et.ZodEnum?{...a,propertyNames:{enum:e.keyType._def.values}}:a}const Yr={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Xr=(e,t)=>{const a=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,a)=>tn(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${a}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return a.length?{anyOf:a}:void 0};function en(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:tn(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:tn(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function tn(e,t,a=!1){const r=t.seen.get(e);if(t.override){const n=t.override?.(e,t,r,a);if(n!==Dr)return n}if(r&&!a){const e=an(r,t);if(void 0!==e)return e}const n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);const i=nn(e,e.typeName,t);return i&&sn(e,t,i),n.jsonSchema=i,i}const an=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:rn(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,a)=>t.currentPath[a]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},rn=(e,t)=>{let a=0;for(;a<e.length&&a<t.length&&e[a]===t[a];a++);return[(e.length-a).toString(),...t.slice(a)].join("/")},nn=(e,t,a)=>{switch(t){case et.ZodString:return Vr(e,a);case et.ZodNumber:return function(e,t){const a={type:"number"};if(!e.checks)return a;for(const r of e.checks)switch(r.kind){case"int":a.type="integer",Br(a,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?Fr(a,"minimum",r.value,r.message,t):Fr(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),Fr(a,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Fr(a,"maximum",r.value,r.message,t):Fr(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),Fr(a,"maximum",r.value,r.message,t));break;case"multipleOf":Fr(a,"multipleOf",r.value,r.message,t)}return a}(e,a);case et.ZodObject:return function(e,t){const a={type:"object",...Object.entries(e.shape()).reduce(((e,[a,r])=>{if(void 0===r||void 0===r._def)return e;const n=tn(r._def,{...t,currentPath:[...t.currentPath,"properties",a],propertyPath:[...t.currentPath,"properties",a]});return void 0===n?e:{properties:{...e.properties,[a]:n},required:r.isOptional()?e.required:[...e.required,a]}}),{properties:{},required:[]}),additionalProperties:en(e,t)};return a.required.length||delete a.required,a}(e,a);case et.ZodBigInt:return function(e,t){const a={type:"integer",format:"int64"};if(!e.checks)return a;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?Fr(a,"minimum",r.value,r.message,t):Fr(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),Fr(a,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Fr(a,"maximum",r.value,r.message,t):Fr(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),Fr(a,"maximum",r.value,r.message,t));break;case"multipleOf":Fr(a,"multipleOf",r.value,r.message,t)}return a}(e,a);case et.ZodBoolean:return{type:"boolean"};case et.ZodDate:return zr(e,a);case et.ZodUndefined:return{not:{}};case et.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(a);case et.ZodArray:return function(e,t){const a={type:"array"};return e.type?._def?.typeName!==et.ZodAny&&(a.items=tn(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Fr(a,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Fr(a,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Fr(a,"minItems",e.exactLength.value,e.exactLength.message,t),Fr(a,"maxItems",e.exactLength.value,e.exactLength.message,t)),a}(e,a);case et.ZodUnion:case et.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Xr(e,t);const a=e.options instanceof Map?Array.from(e.options.values()):e.options;if(a.every((e=>e._def.typeName in Yr&&(!e._def.checks||!e._def.checks.length)))){const e=a.reduce(((e,t)=>{const a=Yr[t._def.typeName];return a&&!e.includes(a)?[...e,a]:e}),[]);return{type:e.length>1?e:e[0]}}if(a.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=a.reduce(((e,t)=>{const a=typeof t._def.value;switch(a){case"string":case"number":case"boolean":return[...e,a];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===a.length){const t=e.filter(((e,t,a)=>a.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:a.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(a.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:a.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return Xr(e,t)}(e,a);case et.ZodIntersection:return function(e,t){const a=[tn(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),tn(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const n=[];return a.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:a,...r}=e;t=r}else r=void 0;n.push(t)}else n.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),n.length?{allOf:n,...r}:void 0}(e,a);case et.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,a)=>tn(e._def,{...t,currentPath:[...t.currentPath,"items",`${a}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:tn(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,a)=>tn(e._def,{...t,currentPath:[...t.currentPath,"items",`${a}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,a);case et.ZodRecord:return Qr(e,a);case et.ZodLiteral:return function(e,t){const a=typeof e.value;return"bigint"!==a&&"number"!==a&&"boolean"!==a&&"string"!==a?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===a?"integer":a,enum:[e.value]}:{type:"bigint"===a?"integer":a,const:e.value}}(e,a);case et.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case et.ZodNativeEnum:return function(e){const t=e.values,a=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(a.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:a}}(e);case et.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:Yr[e.innerType._def.typeName],nullable:!0}:{type:[Yr[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const a=tn(e.innerType._def,{...t,currentPath:[...t.currentPath]});return a&&"$ref"in a?{allOf:[a],nullable:!0}:a&&{...a,nullable:!0}}const a=tn(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return a&&{anyOf:[a,{type:"null"}]}}(e,a);case et.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return tn(e.innerType._def,t);const a=tn(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return a?{anyOf:[{not:{}},a]}:{}})(e,a);case et.ZodMap:return function(e,t){return"record"===t.mapStrategy?Qr(e,t):{type:"array",maxItems:125,items:{type:"array",items:[tn(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},tn(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,a);case et.ZodSet:return function(e,t){const a={type:"array",uniqueItems:!0,items:tn(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Fr(a,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Fr(a,"maxItems",e.maxSize.value,e.maxSize.message,t),a}(e,a);case et.ZodLazy:return tn(e.getter()._def,a);case et.ZodPromise:return function(e,t){return tn(e.type._def,t)}(e,a);case et.ZodNaN:case et.ZodNever:return{not:{}};case et.ZodEffects:return function(e,t){return"input"===t.effectStrategy?tn(e.schema._def,t):{}}(e,a);case et.ZodAny:case et.ZodUnknown:return{};case et.ZodDefault:return function(e,t){return{...tn(e.innerType._def,t),default:e.defaultValue()}}(e,a);case et.ZodBranded:return function(e,t){return tn(e.type._def,t)}(e,a);case et.ZodReadonly:case et.ZodCatch:return((e,t)=>tn(e.innerType._def,t))(e,a);case et.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return tn(e.in._def,t);if("output"===t.pipeStrategy)return tn(e.out._def,t);const a=tn(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[a,tn(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",a?"1":"0"]})].filter((e=>void 0!==e))}})(e,a);case et.ZodFunction:case et.ZodVoid:case et.ZodSymbol:default:return}},sn=(e,t,a)=>(e.description&&(a.description=e.description,t.markdownDescription&&(a.markdownDescription=e.description)),a),on=(e,t)=>{const a=(e=>{const t=(e=>"string"==typeof e?{...Ur,name:e}:{...Ur,...e})(e),a=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,a])=>[a._def,{def:a._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,r])=>({...e,[t]:tn(r._def,{...a,currentPath:[...a.basePath,a.definitionPath,t]},!0)??{}})),{}):void 0,n="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,i=tn(e._def,void 0===n?a:{...a,currentPath:[...a.basePath,a.definitionPath,n]},!1)??{},s="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(i.title=s);const o=void 0===n?r?{...i,[a.definitionPath]:r}:i:{$ref:[..."relative"===a.$refStrategy?[]:a.basePath,a.definitionPath,n].join("/"),[a.definitionPath]:{...r,[n]:i}};return"jsonSchema7"===a.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===a.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o},cn=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function ln(e){return Mr(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...on(e.data.schema),title:e.data.name}}}class un{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,a)=>{var r;e[t.id]="string"==typeof(r=t.id)&&cn.test(r)?a:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...ln(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,t){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const a=t||Ht(),r={id:a,data:e};return this.nodes[a]=r,r}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,a){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const r={source:e.id,target:t.id,data:a};return this.edges.push(r),r}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((a=>{e.has(a.id)||t.push(a)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((a=>{e.has(a.id)||t.push(a)})),t[0]}extend(e){Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[e]=t})),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}}function dn(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function hn(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*pn(e,t){const a=hr.getInstance();for(;;){const{value:r,done:n}=a.run(e,t.next.bind(t));if(n)break;yield r}}async function*mn(e,t){const a=hr.getInstance(),r=t[Symbol.asyncIterator]();for(;;){const{value:n,done:i}=await a.run(e,r.next.bind(t));if(i)break;yield n}}function fn(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class gn extends d{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new yn({bound:this,kwargs:e,config:{}})}map(){return new bn({bound:this})}withRetry(e){return new vn({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new yn({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new xn({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Ar);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const a=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>Ar(0===r?e:a)))}return Array.from({length:t},(()=>Ar(e)))}async batch(e,t,a){const r=this._getOptionsList(t??{},e.length),n=r[0]?.maxConcurrency??a?.maxConcurrency,i=new $r({maxConcurrency:n,onFailedAttempt:e=>{throw e}}),s=e.map(((e,t)=>i.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(a?.returnExceptions)return e;throw e}}))));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const a=Ar(t),r=new gr({generator:this._streamIterator(e,a),config:a});return await r.setup,pr.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=Ar(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const a={...e};return delete a.callbacks,delete a.tags,delete a.metadata,delete a.runName,delete a.configurable,delete a.recursionLimit,delete a.maxConcurrency,delete a.runId,[t,a]}async _callWithConfig(e,t,a){const r=Ar(a),n=await Ir(r),i=await(n?.handleChainStart(this.toJSON(),fn(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let s;delete r.runId;try{s=await e.call(this,t,r,i)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(fn(s,"output"))),s}async _batchWithConfig(e,t,a,r){const n=this._getOptionsList(a??{},t.length),i=await Promise.all(n.map(Ir)),s=await Promise.all(i.map((async(e,a)=>{const r=await(e?.handleChainStart(this.toJSON(),fn(t[a],"input"),n[a].runId,n[a].runType,void 0,void 0,n[a].runName??this.getName()));return delete n[a].runId,r})));let o;try{o=await e.call(this,t,n,s,r)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(fn(o,"output"))))),o}async*_transformStreamWithConfig(e,t,a){let r,n,i=!0,s=!0;const o=Ar(a),c=await Ir(o);let l;try{const a=await async function(e,t,a,...r){const n=new gr({generator:t,startSetup:a}),i=await n.setup;return{output:e(n,i,...r),setup:i}}(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===r)r=t;else try{r=fr(r,t)}catch{r=void 0,i=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,l=a.setup;const u=l?.handlers.find(Er);let d=a.output;void 0!==u&&void 0!==l&&(d=u.tapOutputIterable(l.runId,d));const h=l?.handlers.find(vr);void 0!==h&&void 0!==l&&(d=h.tapOutputIterable(l.runId,d));for await(const e of d)if(yield e,s)if(void 0===n)n=e;else try{n=fr(n,e)}catch{n=void 0,s=!1}}catch(e){throw await(l?.handleChainError(e,void 0,void 0,void 0,{inputs:fn(r,"input")})),e}await(l?.handleChainEnd(n??{},void 0,void 0,void 0,{inputs:fn(r,"input")}))}getGraph(e){const t=new un,a=t.addNode({name:`${this.getName()}Input`,schema:Mt.any()}),r=t.addNode(this),n=t.addNode({name:`${this.getName()}Output`,schema:Mt.any()});return t.addEdge(a,r),t.addEdge(r,n),t}pipe(e){return new _n({first:this,last:Tn(e)})}pick(e){return this.pipe(new Pn(e))}assign(e){return this.pipe(new En(new wn({steps:e})))}async*transform(e,t){let a;for await(const t of e)a=void 0===a?t:fr(a,t);yield*this._streamIterator(a,Ar(t))}async*streamLog(e,t,a){const r=new kr({...a,autoClose:!1,_schemaFormat:"original"}),n=Ar(t);yield*this._streamLog(e,r,n)}async*_streamLog(e,t,a){const{callbacks:r}=a;if(void 0===r)a.callbacks=[t];else if(Array.isArray(r))a.callbacks=r.concat([t]);else{const e=r.copy();e.inheritableHandlers.push(t),a.callbacks=e}const n=this.stream(e,a),i=async function(){try{const e=await n;for await(const a of e){const e=new yr({ops:[{op:"add",path:"/streamed_output/-",value:a}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}streamEvents(e,t,a){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,a);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,a)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,a=new ReadableStream({async start(a){for await(const r of e)a.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));a.enqueue(t.encode("event: end\n\n")),a.close()}});return pr.fromReadableStream(a)}(r):pr.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,a){const r=new Pr({...a,autoClose:!1}),n=Ar(t),i=n.runId??Ht();n.runId=i;const s=n.callbacks;if(void 0===s)n.callbacks=[r];else if(Array.isArray(s))n.callbacks=s.concat(r);else{const e=s.copy();e.inheritableHandlers.push(r),n.callbacks=e}const o=this,c=async function(){try{const t=await o.stream(e,n),a=r.tapOutputIterable(i,t);for await(const e of a);}finally{await r.finish()}}();let l,u=!1;try{for await(const t of r)u?(t.run_id===l&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,u=!0,l=t.run_id,yield t)}finally{await c}}async*_streamEventsV1(e,t,a){let r,n=!1;const i=Ar(t),s=i.tags??[],o=i.metadata??{},c=i.runName??this.getName(),l=new kr({...a,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Zr({...a}),d=this._streamLog(e,l,i);for await(const t of d){if(r=r?r.concat(t):br.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!n){n=!0;const t={...r.state},a={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:s,metadata:o,data:{input:e}};u.includeEvent(a,t.type)&&(yield a)}const a=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),i=[...new Set(a)];for(const e of i){let t,a={};const n=r.state.logs[e];if(t=void 0===n.end_time?n.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==n.inputs&&(a.input=n.inputs);else if("end"===t)void 0!==n.inputs&&(a.input=n.inputs),a.output=n.final_output;else if("stream"===t){const e=n.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${n.name}"`);a={chunk:n.streamed_output[0]},n.streamed_output=[]}yield{event:`on_${n.type}_${t}`,name:n.name,run_id:n.id,tags:n.tags,metadata:n.metadata,data:a}}const{state:l}=r;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const a={event:`on_${l.type}_stream`,run_id:l.id,tags:s,metadata:o,name:c,data:t};u.includeEvent(a,l.type)&&(yield a)}}const h=r?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};u.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return Mr(e)}withListeners({onStart:e,onEnd:t,onError:a}){return new yn({bound:this,config:{},configFactories:[r=>({callbacks:[new Lr({config:r,onStart:e,onEnd:t,onError:a})]})]})}}class yn extends gn{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=jr(this.config,...e);return jr(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(Ar(t),this.kwargs))}async batch(e,t,a){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(Ar(e),this.kwargs)))):await this._mergeConfig(Ar(t),this.kwargs);return this.bound.batch(e,r,a)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Ar(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Ar(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Ar(t),this.kwargs))}streamEvents(e,t,a){const r=this;return pr.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig(Ar(t),r.kwargs),version:t.version},a)}())}static isRunnableBinding(e){return e.bound&&gn.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:a}){return new yn({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new Lr({config:r,onStart:e,onEnd:t,onError:a})]})]})}}class bn extends gn{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new bn({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,a){return this.bound.batch(e,Nr(t,{callbacks:a?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:a}){return new bn({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:a})})}}class vn extends yn{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,a){const r=e>1?`retry:attempt:${e}`:void 0;return Nr(t,{callbacks:a?.getChild(r)})}async _invoke(e,t,a){return Zt((r=>super.invoke(e,this._patchConfigForRetry(r,t,a))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,a,r){const n={};try{await Zt((async i=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===n[e.toString()]||n[e.toString()]instanceof Error)),o=s.map((t=>e[t])),c=s.map((e=>this._patchConfigForRetry(i,t?.[e],a?.[e]))),l=await super.batch(o,c,{...r,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],a=s[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),n[a.toString()]=t}if(u)throw u;return l}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(n).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>n[parseInt(e,10)]))}async batch(e,t,a){return this._batchWithConfig(this._batch.bind(this),e,t,a)}}class _n extends gn{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const a=Ar(t),r=await Ir(a),n=await(r?.handleChainStart(this.toJSON(),fn(e,"input"),a.runId,void 0,void 0,void 0,a?.runName));delete a.runId;let i,s=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const r=e[t];s=await r.invoke(s,Nr(a,{callbacks:n?.getChild(`seq:step:${t+1}`)}))}i=await this.last.invoke(s,Nr(a,{callbacks:n?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(n?.handleChainError(e)),e}return await(n?.handleChainEnd(fn(i,"output"))),i}async batch(e,t,a){const r=this._getOptionsList(t??{},e.length),n=await Promise.all(r.map(Ir)),i=await Promise.all(n.map((async(t,a)=>{const n=await(t?.handleChainStart(this.toJSON(),fn(e[a],"input"),r[a].runId,void 0,void 0,void 0,r[a].runName));return delete r[a].runId,n})));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];s=await t.batch(s,i.map(((t,a)=>{const n=t?.getChild(`seq:step:${e+1}`);return Nr(r[a],{callbacks:n})})),a)}}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(fn(s,"output"))))),s}async*_streamIterator(e,t){const a=await Ir(t),{runId:r,...n}=t??{},i=await(a?.handleChainStart(this.toJSON(),fn(e,"input"),r,void 0,void 0,void 0,n?.runName)),s=[this.first,...this.middle,this.last];let o,c=!0;try{let t=s[0].transform(async function*(){yield e}(),Nr(n,{callbacks:i?.getChild("seq:step:1")}));for(let e=1;e<s.length;e+=1){const a=s[e];t=await a.transform(t,Nr(n,{callbacks:i?.getChild(`seq:step:${e+1}`)}))}for await(const e of t)if(yield e,c)if(void 0===o)o=e;else try{o=fr(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(fn(o,"output")))}getGraph(e){const t=new un;let a=null;return this.steps.forEach(((r,n)=>{const i=r.getGraph(e);0!==n&&i.trimFirstNode(),n!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const s=i.firstNode();if(!s)throw new Error(`Runnable ${r} has no first node`);a&&t.addEdge(a,s),a=i.lastNode()})),t}pipe(e){return _n.isRunnableSequence(e)?new _n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new _n({first:this.first,middle:[...this.middle,this.last],last:Tn(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&gn.isRunnable(e)}static from([e,...t],a){return new _n({first:Tn(e),middle:t.slice(0,-1).map(Tn),last:Tn(t[t.length-1]),name:a})}}class wn extends gn{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,a]of Object.entries(e.steps))this.steps[t]=Tn(a)}static from(e){return new wn({steps:e})}async invoke(e,t){const a=Ar(t),r=await Ir(a),n=await(r?.handleChainStart(this.toJSON(),{input:e},a.runId,void 0,void 0,void 0,a?.runName));delete a.runId;const i={};try{await Promise.all(Object.entries(this.steps).map((async([t,r])=>{i[t]=await r.invoke(e,Nr(a,{callbacks:n?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(n?.handleChainError(e)),e}return await(n?.handleChainEnd(i)),i}async*_transform(e,t,a){const r={...this.steps},n=mr(e,Object.keys(r).length),i=new Map(Object.entries(r).map((([e,r],i)=>{const s=r.transform(n[i],Nr(a,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then((t=>({key:e,gen:s,result:t})))]})));for(;i.size;){const{key:e,result:t,gen:a}=await Promise.race(i.values());i.delete(e),t.done||(yield{[e]:t.value},i.set(e,a.next().then((t=>({key:e,gen:a,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=Ar(t),r=new gr({generator:this.transform(async function*(){yield e}(),a),config:a});return await r.setup,pr.fromAsyncGenerator(r)}}class kn extends gn{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Gt(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[a]=this._getOptionsList(t??{},1),r=await Ir(a);return await this.func(Nr(a,{callbacks:r}),e)}async*_streamIterator(e,t){const a=await this.invoke(e,t);var r;if(hn(a))for await(const e of a)yield e;else if(null!=(r=a)&&"object"==typeof r&&"next"in r&&"function"==typeof r.next)for(;;){const e=a.next();if(e.done)break;yield e.value}else yield a}static from(e){return new kn({func:e})}}class On extends gn{static lc_name(){return"RunnableLambda"}constructor(e){if(Gt(e.func))return kn.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if(Gt(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new On({func:e})}async _invoke(e,t,a){return new Promise(((r,n)=>{const i=Nr(t,{callbacks:a?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});hr.getInstance().run(i,(async()=>{try{let a=await this.func(e,{...i,config:i});if(a&&gn.isRunnable(a)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");a=await a.invoke(e,{...i,recursionLimit:(i.recursionLimit??25)-1})}else if(hn(a)){let e;for await(const t of mn(i,a))if(void 0===e)e=t;else try{e=fr(e,t)}catch(a){e=t}a=e}else if(dn(a)){let e;for(const t of pn(i,a))if(void 0===e)e=t;else try{e=fr(e,t)}catch(a){e=t}a=e}r(a)}catch(e){n(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,a){let r;for await(const t of e)if(void 0===r)r=t;else try{r=fr(r,t)}catch(e){r=t}const n=await new Promise(((e,t)=>{hr.getInstance().run(a,(async()=>{try{const t=await this.func(r,{...a,config:a});e(t)}catch(e){t(e)}}))}));if(n&&gn.isRunnable(n)){if(0===a?.recursionLimit)throw new Error("Recursion limit reached.");const e=await n.stream(r,Nr(a,{callbacks:t?.getChild(),recursionLimit:(a?.recursionLimit??25)-1}));for await(const t of e)yield t}else if(hn(n))for await(const e of mn(a,n))yield e;else if(dn(n))for(const e of pn(a,n))yield e;else yield n}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=Ar(t),r=new gr({generator:this.transform(async function*(){yield e}(),a),config:a});return await r.setup,pr.fromAsyncGenerator(r)}}class xn extends gn{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const a=await qa.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:r,...n}=t??{},i=await(a?.handleChainStart(this.toJSON(),fn(e,"input"),r,void 0,void 0,void 0,n?.runName));let s;for(const t of this.runnables())try{const a=await t.invoke(e,Nr(n,{callbacks:i?.getChild()}));return await(i?.handleChainEnd(fn(a,"output"))),a}catch(e){void 0===s&&(s=e)}if(void 0===s)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(s)),s}async batch(e,t,a){if(a?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),n=await Promise.all(r.map((e=>qa.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)))),i=await Promise.all(n.map((async(t,a)=>{const n=await(t?.handleChainStart(this.toJSON(),fn(e[a],"input"),r[a].runId,void 0,void 0,void 0,r[a].runName));return delete r[a].runId,n})));let s;for(const t of this.runnables())try{const n=await t.batch(e,i.map(((e,t)=>Nr(r[t],{callbacks:e?.getChild()}))),a);return await Promise.all(i.map(((e,t)=>e?.handleChainEnd(fn(n[t],"output"))))),n}catch(e){void 0===s&&(s=e)}if(!s)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(i.map((e=>e?.handleChainError(s)))),s}}function Tn(e){if("function"==typeof e)return new On({func:e});if(gn.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[a,r]of Object.entries(e))t[a]=Tn(r);return new wn({steps:t})}}class En extends gn{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof wn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const a=await this.mapper.invoke(e,t);return{...e,...a}}async*_transform(e,t,a){const r=this.mapper.getStepsKeys(),[n,i]=mr(e),s=this.mapper.transform(i,Nr(a,{callbacks:t?.getChild()})),o=s.next();for await(const e of n){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=Ar(t),r=new gr({generator:this.transform(async function*(){yield e}(),a),config:a});return await r.setup,pr.fromAsyncGenerator(r)}}class Pn extends gn{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=Ar(t),r=new gr({generator:this.transform(async function*(){yield e}(),a),config:a});return await r.setup,pr.fromAsyncGenerator(r)}}var In="object"==typeof window?window:{},jn="0123456789abcdef".split(""),Sn=[-2147483648,8388608,32768,128],An=[24,16,8,0],Nn=[];function Cn(e){e?(Nn[0]=Nn[16]=Nn[1]=Nn[2]=Nn[3]=Nn[4]=Nn[5]=Nn[6]=Nn[7]=Nn[8]=Nn[9]=Nn[10]=Nn[11]=Nn[12]=Nn[13]=Nn[14]=Nn[15]=0,this.blocks=Nn):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Cn.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===In.ArrayBuffer&&(e=new Uint8Array(e));for(var a,r,n=0,i=e.length||0,s=this.blocks;n<i;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(r=this.start;n<i&&r<64;++n)s[r>>2]|=e[n]<<An[3&r++];else for(r=this.start;n<i&&r<64;++n)(a=e.charCodeAt(n))<128?s[r>>2]|=a<<An[3&r++]:a<2048?(s[r>>2]|=(192|a>>6)<<An[3&r++],s[r>>2]|=(128|63&a)<<An[3&r++]):a<55296||a>=57344?(s[r>>2]|=(224|a>>12)<<An[3&r++],s[r>>2]|=(128|a>>6&63)<<An[3&r++],s[r>>2]|=(128|63&a)<<An[3&r++]):(a=65536+((1023&a)<<10|1023&e.charCodeAt(++n)),s[r>>2]|=(240|a>>18)<<An[3&r++],s[r>>2]|=(128|a>>12&63)<<An[3&r++],s[r>>2]|=(128|a>>6&63)<<An[3&r++],s[r>>2]|=(128|63&a)<<An[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=s[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},Cn.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=Sn[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Cn.prototype.hash=function(){var e,t,a=this.h0,r=this.h1,n=this.h2,i=this.h3,s=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)a=(t=(r=(t=(n=(t=(i=(t=(s=(t=a<<5|a>>>27)+(r&n|~r&i)+s+1518500249+o[e]|0)<<5|s>>>27)+(a&(r=r<<30|r>>>2)|~a&n)+i+1518500249+o[e+1]|0)<<5|i>>>27)+(s&(a=a<<30|a>>>2)|~s&r)+n+1518500249+o[e+2]|0)<<5|n>>>27)+(i&(s=s<<30|s>>>2)|~i&a)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(n&(i=i<<30|i>>>2)|~n&s)+a+1518500249+o[e+4]|0,n=n<<30|n>>>2;for(;e<40;e+=5)a=(t=(r=(t=(n=(t=(i=(t=(s=(t=a<<5|a>>>27)+(r^n^i)+s+1859775393+o[e]|0)<<5|s>>>27)+(a^(r=r<<30|r>>>2)^n)+i+1859775393+o[e+1]|0)<<5|i>>>27)+(s^(a=a<<30|a>>>2)^r)+n+1859775393+o[e+2]|0)<<5|n>>>27)+(i^(s=s<<30|s>>>2)^a)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(n^(i=i<<30|i>>>2)^s)+a+1859775393+o[e+4]|0,n=n<<30|n>>>2;for(;e<60;e+=5)a=(t=(r=(t=(n=(t=(i=(t=(s=(t=a<<5|a>>>27)+(r&n|r&i|n&i)+s-1894007588+o[e]|0)<<5|s>>>27)+(a&(r=r<<30|r>>>2)|a&n|r&n)+i-1894007588+o[e+1]|0)<<5|i>>>27)+(s&(a=a<<30|a>>>2)|s&r|a&r)+n-1894007588+o[e+2]|0)<<5|n>>>27)+(i&(s=s<<30|s>>>2)|i&a|s&a)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(n&(i=i<<30|i>>>2)|n&s|i&s)+a-1894007588+o[e+4]|0,n=n<<30|n>>>2;for(;e<80;e+=5)a=(t=(r=(t=(n=(t=(i=(t=(s=(t=a<<5|a>>>27)+(r^n^i)+s-899497514+o[e]|0)<<5|s>>>27)+(a^(r=r<<30|r>>>2)^n)+i-899497514+o[e+1]|0)<<5|i>>>27)+(s^(a=a<<30|a>>>2)^r)+n-899497514+o[e+2]|0)<<5|n>>>27)+(i^(s=s<<30|s>>>2)^a)+r-899497514+o[e+3]|0)<<5|r>>>27)+(n^(i=i<<30|i>>>2)^s)+a-899497514+o[e+4]|0,n=n<<30|n>>>2;this.h0=this.h0+a|0,this.h1=this.h1+r|0,this.h2=this.h2+n|0,this.h3=this.h3+i|0,this.h4=this.h4+s|0},Cn.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4;return jn[e>>28&15]+jn[e>>24&15]+jn[e>>20&15]+jn[e>>16&15]+jn[e>>12&15]+jn[e>>8&15]+jn[e>>4&15]+jn[15&e]+jn[t>>28&15]+jn[t>>24&15]+jn[t>>20&15]+jn[t>>16&15]+jn[t>>12&15]+jn[t>>8&15]+jn[t>>4&15]+jn[15&t]+jn[a>>28&15]+jn[a>>24&15]+jn[a>>20&15]+jn[a>>16&15]+jn[a>>12&15]+jn[a>>8&15]+jn[a>>4&15]+jn[15&a]+jn[r>>28&15]+jn[r>>24&15]+jn[r>>20&15]+jn[r>>16&15]+jn[r>>12&15]+jn[r>>8&15]+jn[r>>4&15]+jn[15&r]+jn[n>>28&15]+jn[n>>24&15]+jn[n>>20&15]+jn[n>>16&15]+jn[n>>12&15]+jn[n>>8&15]+jn[n>>4&15]+jn[15&n]},Cn.prototype.toString=Cn.prototype.hex,Cn.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,a>>24&255,a>>16&255,a>>8&255,255&a,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n]},Cn.prototype.array=Cn.prototype.digest,Cn.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const Rn=(...e)=>{return t=e.join("_"),new Cn(!0).update(t).hex();var t};class $n{}const Ln=new Map;class Mn extends $n{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Rn(e,t))??null)}async update(e,t,a){this.cache.set(Rn(e,t),a)}static global(){return new Mn(Ln)}}class Zn extends d{}class Dn extends Zn{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new b(this.value)]}}class Un extends Zn{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return k(this.messages)}toChatMessages(){return this.messages}}var Bn=a(526),Fn=Object.defineProperty;function zn(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let a=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;a.length>1;){let r=null;for(let n=0;n<a.length-1;n++){const i=e.slice(a[n].start,a[n+1].end),s=t.get(i.join(","));null!=s&&(null==r||s<r[0])&&(r=[s,n])}if(null==r)break;{const e=r[1];a[e]={start:a[e].start,end:a[e+1].end},a.splice(e+1,1)}}return a}(e,t).map((a=>t.get(e.slice(a.start,a.end).join(",")))).filter((e=>null!=e))}var Hn,qn=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const a=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[a,r,...n]=t.split(" "),i=Number.parseInt(r,10);return n.forEach(((t,a)=>e[t]=i+a)),e}),{});for(const[e,t]of Object.entries(a)){const a=Bn.toByteArray(e);this.rankMap.set(a.join(","),t),this.textMap.set(t,a)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,a])=>(e[a]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],a="all"){const r=new RegExp(this.patStr,"ug"),n=qn.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===a?Object.keys(this.specialTokens).filter((e=>!s.has(e))):a);if(o.size>0){const t=qn.specialTokenRegex([...o]),a=e.match(t);if(null!=a)throw new Error(`The text contains a special token that is not allowed: ${a[0]}`)}let c=0;for(;;){let t=null,a=c;for(;n.lastIndex=a,t=n.exec(e),null!=t&&!s.has(t[0]);)a=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),a=this.rankMap.get(e.join(","));null==a?i.push(...zn(e,this.rankMap)):i.push(a)}if(null==t)break;let l=this.specialTokens[t[0]];i.push(l),c=t.index+t[0].length}return i}decode(e){const t=[];let a=0;for(let r=0;r<e.length;++r){const n=e[r],i=this.textMap.get(n)??this.inverseSpecialTokens[n];null!=i&&(t.push(i),a+=i.length)}const r=new Uint8Array(a);let n=0;for(const e of t)r.set(e,n),n+=e.length;return this.textDecoder.decode(r)}},Vn=qn;((e,t,a)=>{t in e?Fn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(Vn,"symbol"!=typeof(Hn="specialTokenRegex")?Hn+"":Hn,(e=>new RegExp(e.map((e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&"))).join("|"),"g")));const Gn={},Jn=new $r({});class Kn extends gn{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Wn extends Kn{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...a}){super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof a.cache?this.cache=a.cache:a.cache?this.cache=Mn.global():this.cache=void 0,this.caller=new $r(a??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in Gn||(Gn[e]=Jn.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new Vn(e))).catch((t=>{throw delete Gn[e],t}))),await Gn[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(a=this.modelName,a.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":a.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":a.startsWith("gpt-4-32k")?"gpt-4-32k":a.startsWith("gpt-4-")?"gpt-4":a.startsWith("gpt-4o")?"gpt-4o":a):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var a;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new Dn(e):Array.isArray(e)?new Un(e.map(w)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const a={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(a).filter((([e,t])=>void 0!==t)).map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return r}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Qn extends Wn{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){const a=Qn._convertInputToPromptValue(e);return(await this.generatePrompt([a],t,t?.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,a){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptions(e){const[t,a]=super._separateRunnableConfigFromCallOptions(e);return a?.timeout&&!a.signal&&(a.signal=AbortSignal.timeout(a.timeout)),[t,a]}async*_streamIterator(e,t){if(this._streamResponseChunks===Qn.prototype._streamResponseChunks)yield this.invoke(e,t);else{const a=Qn._convertInputToPromptValue(e),[r,n]=this._separateRunnableConfigFromCallOptions(t),i=await qa.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s={options:n,invocation_params:this?.invocationParams(n),batch_size:1},o=await(i?.handleLLMStart(this.toJSON(),[a.toString()],r.runId,void 0,s,void 0,void 0,r.runName));let c=new xr({text:""});try{for await(const e of this._streamResponseChunks(a.toString(),n,o?.[0]))c=c?c.concat(e):e,"string"==typeof e.text&&(yield e.text)}catch(e){throw await Promise.all((o??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((o??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}async generatePrompt(e,t,a){const r=e.map((e=>e.toString()));return this.generate(r,t,a)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let a=0;a<e.generations.length;a+=1){const r=e.generations[a];if(0===a)t.push({generations:[r],llmOutput:e.llmOutput});else{const a=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[r],llmOutput:a})}}return t}async _generateUncached(e,t,a){const r=await qa.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),n={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length},i=await(r?.handleLLMStart(this.toJSON(),e,a.runId,void 0,n,void 0,void 0,a?.runName));let s;if(i?.[0].handlers.find((e=>Er(e)||vr(e)))&&1===e.length&&this._streamResponseChunks!==Qn.prototype._streamResponseChunks)try{const a=await this._streamResponseChunks(e[0],t,i?.[0]);let r;for await(const e of a)r=void 0===r?e:fr(r,e);if(void 0===r)throw new Error("Received empty response from chat model call.");s={generations:[[r]],llmOutput:{}},await(i?.[0].handleLLMEnd(s))}catch(e){throw await(i?.[0].handleLLMError(e)),e}else{try{s=await this._generate(e,t,i?.[0])}catch(e){throw await Promise.all((i??[]).map((t=>t?.handleLLMError(e)))),e}const a=this._flattenLLMResult(s);await Promise.all((i??[]).map(((e,t)=>e?.handleLLMEnd(a[t]))))}const o=i?.map((e=>e.runId))||void 0;return Object.defineProperty(s,Or,{value:o?{runIds:o}:void 0,configurable:!0}),s}async _generateCached({prompts:e,cache:t,llmStringKey:a,parsedOptions:r,handledOptions:n,runId:i}){const s=await qa.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),o={options:r,invocation_params:this?.invocationParams(r),batch_size:e.length,cached:!0},c=await(s?.handleLLMStart(this.toJSON(),e,i,void 0,o,void 0,void 0,n?.runName)),l=[],u=(await Promise.allSettled(e.map((async(e,r)=>{const n=await t.lookup(e,a);return null==n&&l.push(r),n})))).map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),d=[];await Promise.all(u.map((async({result:e,runManager:t},a)=>{if("fulfilled"===e.status){const r=e.value;return d[a]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const h={generations:d,missingPromptIndices:l};return Object.defineProperty(h,Or,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),h}async generate(e,t,a){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let r;r=Array.isArray(t)?{stop:t}:t;const[n,i]=this._separateRunnableConfigFromCallOptions(r);if(n.callbacks=n.callbacks??a,!this.cache)return this._generateUncached(e,i,n);const{cache:s}=this,o=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:l}=await this._generateCached({prompts:e,cache:s,llmStringKey:o,parsedOptions:i,handledOptions:n,runId:n.runId});let u={};if(l.length>0){const t=await this._generateUncached(l.map((t=>e[t])),i,n);await Promise.all(t.generations.map((async(t,a)=>{const r=l[a];return c[r]=t,s.update(e[r],o,t)}))),u=t.llmOutput??{}}return{generations:c,llmOutput:u}}async call(e,t,a){const{generations:r}=await this.generate([e],t,a);return r[0][0].text}async predict(e,t,a){return this.call(e,t,a)}async predictMessages(e,t,a){const r=k(e),n=await this.call(r,t,a);return new g(n)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class Yn extends Qn{async _generate(e,t,a){return{generations:await Promise.all(e.map(((e,r)=>this._call(e,{...t,promptIndex:r},a).then((e=>[{text:e}])))))}}}class Xn extends Yn{constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"j2-jumbo-instruct"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:1024}),Object.defineProperty(this,"minTokens",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:Xn.getDefaultAI21PenaltyData()}),Object.defineProperty(this,"countPenalty",{enumerable:!0,configurable:!0,writable:!0,value:Xn.getDefaultAI21PenaltyData()}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:Xn.getDefaultAI21PenaltyData()}),Object.defineProperty(this,"numResults",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ai21ApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e?.model??this.model,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.minTokens=e?.minTokens??this.minTokens,this.topP=e?.topP??this.topP,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.countPenalty=e?.countPenalty??this.countPenalty,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.numResults=e?.numResults??this.numResults,this.logitBias=e?.logitBias,this.ai21ApiKey=e?.ai21ApiKey??Qt("AI21_API_KEY"),this.stop=e?.stop,this.baseUrl=e?.baseUrl}validateEnvironment(){if(!this.ai21ApiKey)throw new Error('No AI21 API key found. Please set it as "AI21_API_KEY" in your environment variables.')}static getDefaultAI21PenaltyData(){return{scale:0,applyToWhitespaces:!0,applyToPunctuations:!0,applyToNumbers:!0,applyToStopwords:!0,applyToEmojis:!0}}_llmType(){return"ai21"}get defaultParams(){return{temperature:this.temperature,maxTokens:this.maxTokens,minTokens:this.minTokens,topP:this.topP,presencePenalty:this.presencePenalty,countPenalty:this.countPenalty,frequencyPenalty:this.frequencyPenalty,numResults:this.numResults,logitBias:this.logitBias}}get identifyingParams(){return{...this.defaultParams,model:this.model}}async _call(e,t){let a=t?.stop;if(this.validateEnvironment(),this.stop&&a&&this.stop.length>0&&a.length>0)throw new Error("`stop` found in both the input and default params.");a=this.stop??a??[];const r=`${this.baseUrl??"j1-grande-instruct"===this.model?"https://api.ai21.com/studio/v1/experimental":"https://api.ai21.com/studio/v1"}/${this.model}/complete`,n={Authorization:`Bearer ${this.ai21ApiKey}`,"Content-Type":"application/json"},i={prompt:e,stopSequences:a,...this.defaultParams},s=await this.caller.callWithOptions({},(async()=>{const e=await fetch(r,{method:"POST",headers:n,body:JSON.stringify(i),signal:t.signal});if(!e.ok){const t=new Error(`AI21 call failed with status code ${e.status}`);throw t.response=e,t}return e.json()}));if(!s.completions||0===s.completions.length||!s.completions[0].data)throw new Error("No completions found in response");return s.completions[0].data.text??""}}const ei={rewrite:"Rewrite the given text for a social social post to reach larger audience and make it sound very professional. Don't change facts but add supporting information if necessary.",format:"Format the given text to look better on social social post. Make sure to add emojis and line breaks wherever necessary.",beautify:"Rewrite and format the given text for a social social post. Keep the tone profesional, use line breaks to make content readable, format text to bold italics or underlined based on context, it should reach large audience, don't change facts, add supporting facts if necessary and add emojis and genZ lingo sparingly. Keep it concise and make it easy to read. Always generate relevant hashtags based on the content. Don't use the word hashtag anywhere. Always make list items bold and add numbers before them."},ti={model:""},ai="AI21APIKey";async function ri({type:e,data:t}){if(t){if(!ti.model){const e=await chrome.storage.local.get(ai);ti.model=new Xn({ai21ApiKey:e[ai]})}!function(e){chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(t){const a=t[0];chrome.tabs.sendMessage(a.id,{data:e,intent:"paste"},(function(){}))}))}(await ti.model.invoke(`${ei[e]} given text: ${t}`))}}chrome.runtime.onMessage.addListener((function(e,t,a){"inform"==e.intent||"copy"==e.intent&&ri(e)})),chrome.commands.onCommand.addListener((e=>{switch(e){case"format":case"rewrite":case"beautify":(async function(e){const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});return await chrome.tabs.sendMessage(t.id,{type:e,intent:"copy"})})(e).then((e=>{ri(e)}))}}))})()})();